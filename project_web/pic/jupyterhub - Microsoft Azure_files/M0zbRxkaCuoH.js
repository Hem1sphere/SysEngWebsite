define("MsPortalImpl/Base/Base.HierarchyMap",["require","exports","f","a","ko"],(function(n,t,i,r,u){"use strict";var f;return (function(n){var t="##-##",i=(function(){function n(){this._observable=u.observableArray()}return n.prototype.addItem=function(n,i){if(n&&n.length){if(n.some((function(n){return!n})))throw new Error("Invalid path segment");else if(this._getItemIndex(n)>=0)throw new Error("Duplicate path '"+JSON.stringify(n)+"'.");}else throw new Error("Invalid path");this._observable.push({path:n,_pathKey:n.join(t),value:i})},n.prototype.removeItem=function(n){var t=this._getItemIndex(n);t>=0&&this._observable.splice(t,1)},n.prototype.removeItemsInPath=function(n){var t=[];this._getItemsWithPath(n,!0,(function(n,i){return!n&&t.push(i)}));this._observable(t)},n.prototype._getItemIndex=function(n){var i=n.join(t);return this._observable.peek().firstIndex((function(n){return n._pathKey===i}))},n.prototype.getItem=function(n){var t=this._getItemIndex(n);return t>=0?this._observable.peek()[t]:null},n.prototype.getItemsInPath=function(n){return this._getItemsWithPath(n,!0)},n.prototype.getItemsUnderPath=function(n){return this._getItemsWithPath(n,!1)},n.prototype.getObservable=function(){return this._observable},n.prototype._getItemsWithPath=function(n,i,r){var u=n.join(t);return this._observable.peek().filter((function(t){var f=t._pathKey.startsWith(u)&&(i||t.path.length>n.length);return r&&r(f,t),f}))},n})();n.HierarchyMap=i})(f||(f={})),f}));
define("MsPortalImpl/UI/Commands/UI.Commands.Blade",["require","exports","f","i","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/UI/Commands/UI.Commands","MsPortalImpl/UI/Commands/UI.ShellCommands"],(function(n,t,i,r,u,f,e){"use strict";var o;return (function(n){function k(n){return t||(o=o||new r.TriggerableLifetimeManager,t=[],t[l]=new h(o,s.bladeRestore,l),t[a]=new h(o,s.bladeMaximize,a)),t[n]}function d(n){t&&(o&&o.dispose(),t=null);t=n}var c=i.Base.Images,y=i.Blades,p=y.Internal.DisplayState,s=u.ShellCommands,w=c.Blank(),b=(function(n){function t(t,i){var r=n.call(this,t,i,s.pinToStartboard,!0)||this;return r.commandName=e.CommandNames.PinBlade,r.icon(c.Pin()),r}return __extends(t,n),t.prototype.execute=function(t){var r=this,u=this._getComposition();return Q.all([i.require("MsPortalImpl/UI/UI.Desktop.Actions"),u.getPinOptions()]).spread((function(n,t){return n.pinBladeToStartboard(t,r._services)})).finally((function(){n.prototype.execute.call(r,t)}))},t})(e.ShellCommand),h,o,l,a,t,v;n.Pin=b;h=(function(n){function t(t,i,r){var u=n.call(this,t,null,i,!0)||this;return u.commandName=e.CommandNames.BladeDisplayState+p[r],u._targetState=r,u.icon(w),u}return __extends(t,n),t.prototype.execute=function(t){var i=f.getBladeContainerWidget($(this._currentContext.target));i&&i.options.displayState(this._targetState);n.prototype.execute.call(this,t)},t.prototype.bind=function(t){var i=f.getBladeContainerWidget($(t.target));n.prototype.bind.call(this,t);this.enabled(i&&this._targetState===i.options.displayState())},t})(e.ShellCommand);n.BladeDisplayStateCommand=h;l=1;a=2;n.getDisplayStateCommand=k;n.setDisplayStateCommands=d;v=(function(n){function t(t,i,r,u){var f=n.call(this,t,u,s.resetLayout,i!==!0)||this;return f.commandName=e.CommandNames.ResetLayout,f.icon(c.Refresh()),f.bind=function(t){n.prototype.bind.call(f,t);f.enabled(i!==!0&&r()!==0)},f}return __extends(t,n),t.prototype.execute=function(t){this._getComposition().resetLayout();n.prototype.execute.call(this,t)},t.prototype.bind=function(){},t})(e.ShellCommand);n.ResetLayout=v})(o||(o={})),o}));
define("MsPortalImpl/UI/Commands/UI.CommandBarManager",["require","exports","f","i","o","ko","FxInternal/Composition/ViewModel","MsPortalImpl/Base/Base.ImplUtils","MsPortalImpl/UI/Commands/UI.Commands","MsPortalImpl/UI/Commands/UI.Commands.Blade","MsPortalImpl/UI/Compositions/UI.Composition.PropertyBinding","MsPortalImpl/UI/UI.DesktopManager","MsPortalImpl/Widgets/Widgets.CommandBar","MsPortalImpl/UI/Compositions/UI.Composition.Selectable2Registrar"],(function(n,t,i,r,u,f,e,o,s,h,c,l,a,v){"use strict";function d(n,t,i,r){var u=p(),f=p(),e=p(),o,h;return n.registerForDispose((function(){u().forEach(y);f().forEach(y);e().forEach(y)})),tt(n,t,i,e),o=s.getCommandGroupForDefinitionItem(i.finder,t.extension.name,t.bladeDefinition),o?g(n,t,i,o,r,u):nt(n,t,i.diContainer,f),h=t.widget.options.commandBar.menuItems,w(n,(function(){var n=i.diContainer.get(l.DesktopManagerMode).value()===1?e():u();n.length||(n=f());h(n.slice())})),Q()}function g(n,t,i,r,u,f){var h=t.widget,e=r.commands.map((function(r){var f=new s.ExtensionCommandMenuItemImpl(n,t.extension,t,r,t.bladeDefinition,i,u);return f.activate(),f})),o=h.options.contextMenu.menuItems;o.push.apply(o,e);f(e)}function nt(t,i,u,s){var p=i.bladeDefinition.toolbar,a=p?p.source.valuesFrom[0]:null,h,l,y;a&&(h=i.children.mapMany((function(n){return n.children})).first((function(n){return n.locator.name===a.part})),y=f.observable(!0),i.uiBlockers.push(y),h.awaitCommandBar().then((function(){var p=h.getViewModel(0),d=c.getModelValue(p,a.property),y,g,nt;d.exists?(i.widget.options.renderCmdBarWhenNoCmd(!0),y=d.value.items,b(y)?(g=y.map(t,(function(n,t){return f.ignoreDependencies((function(){return k(n,t,h.locator,u)}))})),w(t,(function(){var n=g();f.ignoreDependencies((function(){v.registerOpenBladeCommands(y(),p,h,"commandBar2Selectables",undefined)?s(n):s([])}))}))):l="Invalid view model for the toolbar at '{0}' in part '{1}'. It is missing the items property"):e.isV2(p.content())||(l="Unable to find the view model for the toolbar at '{0}' in part '{1}'.");l&&(l=l.format(a.property,h.locator.toFriendlyString()),nt=r.createError(l),o.logToExtension(n,h.extension.name,2,nt))})).finally((function(){return y(!1)})))}function tt(n,t,i,r){var e=t.containerWidget,f=t.widget.options,u;f.locked()||i.diContainer.get(l.DesktopManagerMode).value.subscribeAndRun(n,(function(o){if(u&&u.dispose(),o===1){u=n.createChildLifetime();var c=new h.ResetLayout(u,f.locked(),f.displayState,i);c.activate();c.bind(new s.CompositionInstanceCommandContext(e.element[0],function(){return Q(e.getContentWidget())},t));r([c])}else r.removeAll().forEach(y)}))}u.defineProperty(t,"__esModule",{value:!0});var b=i.isObservableArray,it=i.Base.Diagnostics,p=f.observableArray,w=f.reactor,k=a.createItem,y=i.disposeDisposable;t.create=d}));
define("MsPortalImpl/UI/Compositions/UI.Composition.Blade.Actions",["require","exports","o"],(function(n,t,i){"use strict";function f(n,t,i,f,e,o){var s=t()||r,h;e=e||r;f=f||r;h=o?e:n.menuBlade||i?u:i&&s!==f?s:e;t(h)}i.defineProperty(t,"__esModule",{value:!0});var r=1,u=2;t.applyDisplayState=f}));
define("MsPortalImpl/UI/Compositions/UI.Composition.Lens",["require","exports","f","i","o","ko","MsPortalImpl/UI/Compositions/UI.Composition","MsPortalImpl/UI/Compositions/UI.Composition.Base","MsPortalImpl/UI/Compositions/UI.Composition.Part","MsPortalImpl/Widgets/Widgets.Lens","MsPortalImpl/Base/Base.EventTypes"],(function(n,t,i,r,u,f,e,o,s,h,c){"use strict";function b(n){var t=n.services.finder.locate(n.locator);return t&&t.isSummary}function k(n,t){var i=n.finder.locate(t),u=new l(n,t),r;return i&&i.partInstances&&(r=[],i.partInstances.forEach((function(i){var u=s.create(n,t.withPartInstance(i.name));r.push(u)})),u.addChildren(r)),u}var l;u.defineProperty(t,"__esModule",{value:!0});var a=i.Base,v=a.Diagnostics,y=e.CompositionType,p=c.default,w=v.createLog(n);l=(function(n){function t(t,i,r,u,f){var e=n.call(this,"Lens",t,i,r,u,f)||this;return e._childOnInputsSetsResolved=Q.defer(),e._childAboveTheFoldOnInputsSetsResolved=Q.defer(),e}return __extends(t,n),t.prototype.awaitChildrenOnInputsSetsResolved=function(){return this._childOnInputsSetsResolved.promise},t.prototype.awaitChildrenAboveTheFoldOnInputsSetsResolved=function(){return this._childAboveTheFoldOnInputsSetsResolved.promise},t.prototype.getCompositionType=function(){return y.Lens},t.prototype._compose=function(n,t,i){var u=this,e,a=Q({}),s=b(this),c;if(i=i||{},e=new h.ViewModel(this.id,this.widgetState()),f.computed(this,(function(){e.locked(n.options.locked())})),c=$(r.createElement("div",{"class":s?"fxs-portal-border":""})),this.widget=new h.Widget(c,e),this._attachWidgetErrorEvent(),s?(e.locked(!0),n.setSummary(c)):n.addChild(this.widget),this.services.finder.locateAsync(this.locator.getExtensionLocator()).done((function(n){var t=u.services.finder.locate(u.locator),i;t&&t.title&&(i=t.title,i?e.title(i):w.error("Lens {0} in extension {1} is missing title.".format(u.locator.toString(),n.name)))})),this.children){var l=this.children.length,o=l,v=this.children.slice();v.forEach((function(n,t){var f=!t,r;n.await(3).finally((function(){l--;l||u._childOnInputsSetsResolved.resolve();n.getLoadDelayed()||(o--,o||u._childAboveTheFoldOnInputsSetsResolved.resolve())}));r=f&&(i.noDelayOnFirstPart||s);n.compose(u.widget,undefined,{delayLoadPromise:r?null:i.delayLoadPromise,noDelayOnFirstPart:i.noDelayOnFirstPart,delayLoad:i.delayLoad});n.getLoadDelayed()&&(o--,o||u._childAboveTheFoldOnInputsSetsResolved.resolve())}))}this.save();a.then((function(){t.resolve()}))},t.prototype.resetLayout=function(){var n=this,t=this.services.finder.locate(this.locator);t&&t.partInstances&&(this.removeChildren(),t.partInstances.forEach((function(t){var r=n.locator.withPartInstance(t.name),i=s.create(n.services,r),u={partId:i.id,lensId:n.id};n.addChildren([i]);i.compose(n.widget);n.widget.trigger(p.fxrearrange,null,u)})))},t})(o.Instance);t.Instance=l;t.create=k}));
define("MsPortalImpl/UI/Compositions/UI.Composition.Blade",["require","exports","f","i","o","a","ko","$","MsPortalImpl/UI/UI.DialogManager","MsPortalImpl/Base/Base.EventTypes","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/Base/Base.Router.Blade","MsPortalImpl/Base/Telemetry","MsPortalImpl/Extension/Extension","MsPortalImpl/Extension/Extension.Definition.Locator","MsPortalImpl/Interactions/Interactions.FocusHandler","MsPortalImpl/Interactions/Interactions.PortalReader","MsPortalImpl/Services/Services.EditScopeManagement","MsPortalImpl/Widgets/Widgets.Blade","MsPortalImpl/Widgets/Widgets.BladeContent","MsPortalImpl/Widgets/Widgets.CommandBar","MsPortalImpl/Widgets/Widgets.UIElementBase","MsPortalImpl/UI/Commands/UI.CommandBarManager","MsPortalImpl/UI/Commands/UI.Commands","MsPortalImpl/UI/Commands/UI.Commands.Blade","MsPortalImpl/UI/UI.DesktopManager","MsPortalImpl/UI/Compositions/UI.Composition","MsPortalImpl/UI/Compositions/UI.Composition.Base","MsPortalImpl/UI/Compositions/UI.Composition.Blade.Actions","MsPortalImpl/UI/Compositions/UI.Composition.BladeOpener.Helpers","MsPortalImpl/UI/Compositions/UI.Composition.CompositionAwaiter","MsPortalImpl/UI/Compositions/UI.Composition.CompositionBinder","MsPortalImpl/UI/Compositions/UI.Composition.Lens","MsPortalImpl/UI/Compositions/UI.Composition.PropertyBinding","MsPortalImpl/UI/Compositions/UI.Composition.Security","MsPortalImpl/UI/Compositions/UI.Composition.StartboardPart"],(function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p,w,b,k,d,g,nt,tt,it,rt,ut,ft,et,ot,st,ht,ct,lt,at,vt,yt){"use strict";function gi(n){return n.getExtensionLocator()}function si(n){var t=n&&gi(n);return t&&t.name}function dt(n){return n&&n.toFriendlyString()}function pr(){return location.hash.split("?")[0]}function ku(n,t,i){var r=new nr(n,t.locator),e={};if(!i)throw new Error("masterContainer is required when creating a blade.");r.masterContainer=i;r.masterCommandId=t.masterCommandId;r.masterCommandName=t.masterCommandName;r.masterCommandExtension=t.masterCommandExtension;r.masterPartId=t.masterPartId;r.masterInvocationProperty=t.masterInvocationProperty;r.masterInputKeys=t.masterInputKeys;r.masterDetailsDefinition=t.masterDetailsDefinition;r.flags=t.flags;var u=t.masterPartId?t.masterPartId.split("-"):[],o=t.openedByContext,f=r.openedByInfo={};return u.length&&u[0]===yt.startboardPartName&&(f.openedBy=u[1]==="BladeLauncher"?o?2:3:1,f.openedByContext=t.openedByContext,f.openedByPartName=u[1]),n.finder.tryLocate(t.locator,e)&&(r.bladeDefinition=e.value,r.extension=n.finder.locate(gi(t.locator))),r.setInputsViewModel(ct.CompositionBinder.createObservableModel(t.model)),r.bindings=t.bindings||[],r.restorationState=t.flags===undefined||t.flags&4?0:1,r}function wr(n){return!(n.menuBlade||n.style===12||(n.lenses||[]).some((function(n){return(n.partInstances||[]).some((function(n){return n.parameterProvider}))})))}function ur(n,t,i){var f=n.options,u,r;f.showTranslucentSpinner(!1);i.menuBlade&&(n.clearDetailContent({clearPlaceholderDetailContent:!0}),t.bladeWidth(2));u=t.contextMenu;r=u&&u.menuItems;r&&r.splice(0,r().length)}function br(n){var t=n.effectiveInputs;return t&&t.length&&n.assetIdInputProperty&&n.assetType}function kr(n){var t=n&&n.options,i=t&&t.unauthorizedNoticeVm;return!!ki(i)}function dr(n,t,i){var e,r={exists:!1,value:undefined},u,f;return br(n)&&(e=n.effectiveInputs.first((function(t){return t.property===n.assetIdInputProperty})),u=e&&e.valuesFrom,f=u&&u[0]&&u[0].property,f&&u[0].referenceType===1&&(r=at.getModelValue(t,f),r.exists?r.value=ii(r.value):bt.error("Asset id property '"+f+"' does not exist in model for composition '"+i+"'. Model='"+yi(t)+"'"))),r}function fr(n){return{id:dt(n.locator),instanceId:n.instanceId}}function gr(n,t){for(var u,r=n.detailContainers,f=function(n){var f=r[n],i,u;if(t(f))return i=f.containerWidget,i&&(u=document.activeElement,u&&o.contains(i.element[0],u)||pi.setTimeout((function(){i.setFocus()}),150)),"break"},i=r.length-1;i>=0;i--)if(u=f(i),u==="break")break}function ri(n,t,i,r,u,f,e,o){var s=at.getModelValue(i,r);s.exists?n.mapProperty(r,e||r).bind(t,i,!0,(function(){var n=ii(at.getModelValue(i,r,!0).value);u(n||f)})):o||ut.isTraceEnabled&&bt.warning("The Blade VM with id "+t+" is missing the "+r+" field.")}function du(n,t,i){var u=t?t.name:null,f=i?i.assetType:null,r=1;n.children.forEach((function(t){t.children.forEach((function(t){ni.trace({extension:u,source:dt(n.locator),action:pt.PartPosition,assetType:f,name:dt(t.locator),data:r});r++}))}))}function gu(n,t){function i(n){r(n||null)}var r=wt(),u=n.bladeDefinition;return ti(n,(function(){var f=ii(t.icon),r,e,o;f?i(f):u.assetType?(r=void 0,(r=n.assetId())?(e=n.extension,o={assetId:r,assetType:u.assetType,extensionName:e.name},Q.delay(1).then((function(){return n.services.assetTypeService.mapAssetIdToDynamicSelectionAndIcon(o,{reason:"BladeIcon"})})).then((function(n){i(n&&n.icon||d.defaultSvg)})).catch((function(){i(d.defaultSvg)}))):i(d.defaultSvg)):i()})),{icon:r}}function ai(n,t,i){lu&&bt.verbose("[BladeRebinding] "+t+" Blade: "+n+". Updated Properties: "+(yi(i,null,2)||"N/A"))}function nf(n,t,r){if(!n)return!1;var u=n.properties.filter((function(n){var t=n.compositionBindingDefinition;return t&&t.source&&t.source.modelType===1}));return u.length===0?!1:u.some((function(n){var u=ii(t[n.sourceProperty]),f=ii(r[n.sourceProperty]);return!i.deepEquals(u,f)}))}function tf(n,t,i,r){var s=!1,u,f,o=e.observable(),h=function(t){var e=!1,h=t.onClick||t.onActivated,c,l;f&&(f.dispose(),f=undefined,u=undefined);c=n.detailContainers.first((function(t){return t.masterCommandName===rr.format(n.bladeDefinition.name)&&t.masterPartId===n.id}));c&&n.services.desktop.forceCloseBlade(c.id);t.selection?(e=!0,f=n.createChildLifetime(),u=it.createOpenBladeCommand(f,n.services,n,n.bladeDefinition,n.extension,rr.format(n.bladeDefinition.name)),o(u.viewModel.container),o().selectable.selectedValue(t.selection),l=(n.detailContainers||[]).length<=0,r()&&l&&!s&&(u.execute(!1),s=!0)):h&&h.uri?(e=!0,f=n.createChildLifetime(),u=it.createOpenLinkCommand(f,n.services,n,n.bladeDefinition,n.extension,rr.format(n.bladeDefinition.name),h)):t.onClick&&(e=!0);i.contentState(t.state);i.contentStateDisplayText(t.text);i.statusBar.activatable(e)},c=function(n){n&&n.state!==0||(n={text:"",state:0,selection:null});h(n)};return t.subscribeAndRun(n,c),ti(n,(function(){var r=o()&&o().selectable.isSelected(),n=ki(t);i.statusBar.activated(r);r&&n&&typeof n.onActivated=="function"&&n.onActivated()})),function(){var i,n;if(u&&u.execute(!1),i=ki(t),i&&(n=i.onClick,n))if(typeof n=="function")n();else if(typeof n.onLinkOpened=="function")n.onLinkOpened(!1)}}function rf(){function r(){n&&(n.reject(new vi.CanceledError("Throttler cancel pending promise")),pi.clearTimeout(i),n=null)}var n,t=0,i;return{rejectPendingPromise:r,throttle:function(){var f=Date.now(),e=f-t,o=e<lr,u;return t=f,r(),o?(u=n=Q.defer(),i=pi.setTimeout((function(){u===n&&(n.resolve(),n=null)}),lr),u.promise):Q()}}}function er(n){var t=ft.getBladeType(n);return t===3&&n.menuBlade.isV2||t===1&&n.templateBlade.isV2||t===2||t===5}function nu(n){n.subtitle("");n.titleSuffix("");n.subtitleSuffix("");n.description("");n.helpUri("");n.icon(sr.Blank());n.contentState(0);n.contentStateDisplayText("")}function uf(n){while(n){if(ff(n))return!0;var t=n.masterContainer;n=t instanceof nr?t:null}return!1}function ff(n){var t=n.getInputPropertyBindings(),i=l.getGalleryItemIdFromBladeComposition(si(n.locator),n.locator.name,t&&t.targetModel);return!!i}var ui,nr,hi,ei;u.defineProperty(t,"__esModule",{value:!0});var tu=r.Extension,gt=r.TelemetryContext,tr=gt.ContextType,ir=i.Base,vi=i.Errors,iu=ir.Constants,ru=iu.BladeParameterNames,or=ir.Diagnostics,ni=or.Telemetry,sr=ir.Images,uu=sr.Shell,fu=i.Extension,eu=fu.SetRequirement,ou=i.ViewModels,su=ou.Controls.Notice,hu=su.ViewModel,kt=ni.ActionModifier,pt=a.Action,fi=a.Source,cu=i.tryImmediateResolve,o=jQuery,pi=window,bt=or.createLog(n),ci=c.Asset,wi=c.Blade,oi=c.Shell.Reader,rr="__{0}_StatusBarCommandDefinitionName__",lu=!!i.trace.bladerebind,hr=Math.random()<.5,li=i.isNullOrUndefined,au="fxs-menublade",cr="fxs-blade-shows-pending",bi=f.isArray,lr=1e3,vu="ResourceMenuBlade",wt=e.observable,ti=e.reactor,ii=e.unwrap,yi=e.toJSON,ar=e.utils,ki=ar.peekObservable,yu=0,vr=i.forEachKey,yr=i.disposeDisposable,di=JSON.stringify,pu=[undefined,"StartboardPart","SideBar","DeepLink"],wu=(hi={},hi[0]="Small",hi[1]="Medium",hi[2]="Large",hi[3]="XLarge",hi[51]="Menu",hi),bu=(ei={},ei[0]="Default",ei[1]="TemplateBlade",ei[2]="FrameBlade",ei[3]="MenuBlade",ei[4]="AppBlade",ei[5]="AzBlade",ei);t.create=ku,(function(n){n[n.ErrorUnrecoverable=1]="ErrorUnrecoverable";n[n.ErrorInitializing=2]="ErrorInitializing";n[n.ErrorLoadingExtension=3]="ErrorLoadingExtension";n[n.ErrorLoadingDefinition=4]="ErrorLoadingDefinition";n[n.ErrorLoadingExtensionAndDefinition=5]="ErrorLoadingExtensionAndDefinition"})(ui||(ui={}));nr=(function(n){function t(t,r,u,f,s){var h=n.call(this,"Blade",t,r,u,f,s)||this;h._disposablesEvents=[];h._widgetReadyToDisplayAwaiter=Q.defer();h._partAwaiter=new ht.CompositionAwaiter(!0);h._containerAwaiter=new ht.CompositionAwaiter;h._bindingResult=wt();h._disabled=!1;h._rebinding=!1;h._composing=!1;h._initialized=!1;h._callbacks=[o.Callbacks(),o.Callbacks(),o.Callbacks()];h._initialOnInputsSetDeferred=Q.defer();h._bladeViewModelDeferred=Q.defer();h._compositionDeferred=Q.defer();h._lastInputsSetDeferred=Q.defer();h._lastInputsSetProperties={};h._markers={};h._perfData={};h._bladeSummaryCollapsed=!1;h._isOpenedByReferrer=wt(!1);h._autoOpenSettingsDisabled=!1;h.masterContainer=null;h.masterInputKeys=[];h.masterDetailsDefinition=null;h.detailContainers=[];h.bindings=[];h.editScopeId=wt();h.title=wt("");h.subtitle=wt("");h.titleSuffix=wt();h.subtitleSuffix=wt();h.description=wt("");h.helpUri=wt();h.helpContentUri=wt();h.shieldType=wt();h.uiBlockers=e.observableArray([]);h.icon=wt(uu.DefaultBlade());h.titleImageUri=wt();h.rebindThrottler=rf();h.assetId=wt();h.restorationState=0;h._beforePageUnload=function(n){return h.shouldAlertOnClose()&&(n.preventDefault(),n.returnValue=""),undefined};var c=yu++,l=0,a=h._updateRebindSequenceNumber=function(){h.instanceId="Blade_"+i.sessionId+"_"+c+"_"+l++};return a(),h._shellViewModel={},h.title(k.getDefaultTitle(r&&r.name)),window.addEventListener("beforeunload",h._beforePageUnload),h._compositionDeferred.promise.then((function(){if(h.bladeDefinition&&h.bladeDefinition.locked){var n=h.getParts();ti(h,(function(){var t=n.some((function(n){return n.triggeringLockedBladeSpinner()}));h.containerWidget.options.showTranslucentSpinner(t);t?w.read(oi.bladeBusy.format(h.title()||""),0,"blade"):w.read(oi.bladeReady.format(h.title()||""),0,"blade")}))}})),h}return __extends(t,n),t.prototype.shouldAlertOnClose=function(n){return n===void 0&&(n=!1),this.children.some((function(t){return t.children.some((function(t){return t.shouldAlertOnClose(n)}))}))},t.prototype.getAlertOnCloseMessages=function(){var n=[];return this.children.forEach((function(t){t.children.forEach((function(t){var i=t.getAlertMessage();i&&n.push(i)}))})),n},t.prototype.isRestorable=function(){return this.restorationState===0?!this.detailContainers.some((function(n){return n.restorationState===1})):!1},t.prototype.initialOnInputsSetPromise=function(){return this._initialOnInputsSetDeferred.promise},t.prototype.getViewModel=function(n,t){var i,r=this.locator,f,u;n=li(n)?1:n;switch(n){case 1:i=this._shellViewModel;break;case 3:if(this.isComposed)this.bladeDefinition.viewModelName||bt.error("Blade '"+r+"' does not define an extension view model.");else throw new Error("Blade '"+this+"' needs to be composed before retrieving its extension view model.");i=this._extensionViewModel;break;case 2:if(this.isComposed)this.actionBar?i=this.actionBar.getViewModel():(bt.error("Blade '"+r+"' does not have an action bar."),i={});else throw new Error("Blade '"+this+"' needs to be composed before retrieving its action bar's view model.");break;case 4:f=this._getCommands();u=ft.findCommand(f,t,this+"");i=u&&u.getViewModel();break;case 999:i={bladeParameters:this._shellViewModel};break;default:bt.error("Invalid model type '"+n+"' for blade '"+r+"'.")}return i||{}},t.prototype.getDeepLink=function(n){var t=this;return this.awaitComposed().then((function(){return t.bladeDefinition.viewModelInputs&&t.initialOnInputsSetPromise()})).then((function(){var r,i;return t._useDetailContent||t.flags&1||(i=t.getInputPropertyBindings(),r=l.getDeepLink(t.services.diContainer,t.extension,t.bladeDefinition,i&&i.targetModel,t.selectedMenuItemId(),t.assetType,ii(t.assetId),t.isPinnable())),r||(t._useDetailContent||!n)&&t.masterContainer.getDeepLink()}))},t.prototype.selectedMenuItemId=function(){var n=this._menu;return n&&n.getSelectedId()},t.prototype.getViewModelAsync=function(n,t){var i=this;return(n=li(n)?1:n,n===1)?Q(this._shellViewModel):this._compositionDeferred.promise.then((function(){if(n===4){var u=i._getCommands(),r=ft.findCommand(u,t,i+"");return r&&r.getViewModelAsync()}return n===3?i._extensionViewModelPromise:i.getViewModel(n)}))},t.prototype.setInputsViewModel=function(n){this._shellViewModel=n;var t=this.bladeDefinition;t&&bi(t.optionalInputs)&&t.optionalInputs.forEach((function(t){n[t]||(n[t]=wt())}))},u.defineProperty(t.prototype,"isInitialized",{get:function(){return this._initialized},enumerable:!0,configurable:!0}),u.defineProperty(t.prototype,"eligibleForBinding",{get:function(){return!0},enumerable:!0,configurable:!0}),u.defineProperty(t.prototype,"journeyPath",{get:function(){return this._journeyPath||(this._journeyPath=this._buildJourneyPath())},enumerable:!0,configurable:!0}),u.defineProperty(t.prototype,"dirtyAndNotSaving",{get:function(){return this.services.diContainer.get(b.EditScopeManager).getStateObservable(this.editScopeId())()===1},enumerable:!0,configurable:!0}),t.prototype.getCompositionType=function(){return ft.CompositionType.Blade},t.prototype.isDefaultTitle=function(){return k.getDefaultTitle(this.locator.name)===this.title()},t.prototype.canAutoOpenSettings=function(){return!this._autoOpenSettingsDisabled&&!this._isOpenedByReferrer()},t.prototype.getPermissionPromise=function(){return this._hasPermissionsDeferred.promise},t.prototype.matchesLocatorAndModel=function(n,t){var r=this.bladeDefinition,i;return!n.equals(this.locator)||!r?!1:(i=e.toJS(this._shellViewModel),n.equals(y.resourceMenu))?(t.id||"").toLowerCase()===(i.id||"").toLowerCase():(r.inputs||[]).every((function(n){return t[n]===i[n]}))},t.prototype.getInputsOnlyViewModel=function(){var n=this._shellViewModel,r=this.bladeDefinition,t=r&&r.outputs;return t&&t.length>0&&(n=i.clone(this._shellViewModel),t.forEach((function(t){delete n[t]}))),n},t.prototype.onAddingContent=function(n){return this.compose(n),Q()},t.prototype.onRemovingContent=function(n){n.clear()},t.prototype.canRemoveContent=function(){return this.services.desktop.tryCloseBlade(this.id)},u.defineProperty(t.prototype,"isDisabled",{get:function(){return this._disabled},enumerable:!0,configurable:!0}),t.prototype.isPinnable=function(){var n=this.bladeDefinition;return i.isFeatureEnabled("pinnable_default_off")?!!(n&&n.pinnable):n&&n.pinnable!==!1&&(n.pinnable===!0||!n.locked)},t.prototype.getPinOptions=function(){var f=this,t,i,r,u,e=this.detailContainers,n=e[0];return e.length===1&&n._useDetailContent&&n.isPinnable()?(t=this.getDeepLink(),i=n.locator,r=n.getViewModel(),u=n.getOnPinFunction()):(i=this.locator,r=this.getViewModel(),t=Q(undefined),u=this.getOnPinFunction()),Q.all([u,t]).spread((function(n,t){return{locator:i,deepLink:t,model:r,bladeTitle:f.containerWidget.options.title(),defaultMenuItemId:f.selectedMenuItemId(),onPin:n}}))},t.prototype.getOnPinFunction=function(){var n=this;return this.await(3).then((function(){var t=n._extensionViewModel&&n._extensionViewModel.content();return t&&t._msPortalFxV2ShellApi&&t._msPortalFxV2ShellApi().onPin}))},t.prototype.getAssetInstanceMetadataAsync=function(){var n=this;return this.awaitComposed().then((function(){var i=n.bladeDefinition,t;return br(i)&&!n.isDisabled&&!n.isDisposed()&&(t=dr(i,n._shellViewModel,n.locator.toString()),t.exists)?{id:t.value,type:n.assetType}:undefined}))},u.defineProperty(t.prototype,"assetType",{get:function(){var n=this.bladeDefinition;return n&&n.assetType},enumerable:!0,configurable:!0}),t.prototype.offRebind=function(n,t,i){var r=this;[n,t,i].forEach((function(n,t){n&&r._callbacks[t].remove(n)}))},t.prototype.onRebind=function(n,t,i){var r=this;[n,t,i].forEach((function(n,t){n&&r._callbacks[t].add(n)}))},t.prototype.save=function(t){this._composing||this._rebinding||kr(this.widget)||!this.masterContainer||n.prototype.save.call(this,t)},t.prototype.rebindAsync=function(n){var t=this;this._rebindStartTime=Date.now();this._endTraceWithState(pt.BladeRebind,kt.Cancel);this._updateRebindSequenceNumber();gt.provideContext((function(){t._creationState=gt.getState()}),tr.Blade,fr(this));this._bladeStartTelemetry(pt.BladeRebind,ft.tryGetAssetType(n));var e=this.widget,u=e&&e.element.findByClassName("fxs-blade-content")[0],r=u&&o(u).find(".fxs-part:first")[0];r&&(p.FocusHandler.Instance.registerContainerForFocus(u),p.FocusHandler.Instance.registerTargetForFocus(r));this.containerWidget.resetInternalState();var f=this.services.desktop,i,h=ft.deepSubset(this._shellViewModel,n),s=function(n){ai(t,"Rebind COMPLETED.");t._rebinding=!1;t.save();o(f).trigger(ut.DesktopManagerEvents.bladeRebound,{id:t.id});t.widget.options.loaded(!0);f.commandsEnabled(!0);g.toggleTemporarilyDisabledCommands(!1);r&&p.FocusHandler.Instance.notifyTargetReadyForFocus(r);t._endTraceWithState(pt.BladeRebind,n)};return ai(this,"Rebind STARTED.",n),this._rebindValidationPromise=null,this._waitToRebindPromise=null,h?(ai(this,"Updated properties are empty or are equal to the current blade properties. Aborting rebind.",n),this.rebindThrottler.rejectPendingPromise(),s(kt.Cancel),i=Q({})):(this._rebinding=!0,this._hasPermissionsDeferred=Q.defer(),this._autoOpenSettingsDisabled=this._useDetailContent,this.bladeDefinition&&!this.bladeDefinition.locked&&this.widget.options.loaded(!1),g.toggleTemporarilyDisabledCommands(!0),f.commandsEnabled(!1),i=this._waitToRebindPromise=this.rebindThrottler.throttle().then((function(){return t.isDisposed()?Q.reject(new vi.CanceledError("Rebind Canceled. Blade is already disposed."+t)):i===t._waitToRebindPromise?(ai(t,"Rebind after throttle.",n),t._rebindAsync(n).finally((function(){i===t._waitToRebindPromise&&s(kt.Complete)}))):Q.reject(new vi.CanceledError("Another rebind already started"))}))),i},t.prototype._bladeReadyEndTelemetry=function(n,t,i){this._endTraceWithState(pt.BladeReady,n,i);t&&(this.fullReadyTime=this._endTraceWithState(pt.BladeFullReady,n,i))},t.prototype._bladeRevealedEndTelemetry=function(n,t,i){this._endTraceWithState(pt.BladeRevealed,n,i);t&&this._endTraceWithState(pt.BladeFullRevealed,n,i)},t.prototype._bladeOpenEndTelemetry=function(n,t,i){this._endTraceWithState(pt.BladeOpened,n,i);t&&this._endTraceWithState(pt.BladeFullOpened,n,i)},t.prototype._endTraceWithState=function(n,t,i){var r=this,u=this._markers,f=function(){var s=u[n],l;if(s){var h=ni.endTrace(s,t,i),e="Menu"+n,f=r.masterContainer,c=f._markers;return r._useDetailContent&&e in c&&(delete c[e],l=Date.now()-(n==="BladeRebind"?f._rebindStartTime:f._readyStartTime),f.initialOnInputsSetPromise().finally((function(){gt.usingState((function(){var u=f.locator,s=r.locator,n=f._menu,c=n&&n.getResourceType()||f.assetType,a=n&&n.getTelemetryInfo()||{};ni.trace({name:dt(u),extension:si(u),source:fi.Shell,action:e,actionModifier:t,data:o.extend({detailName:dt(s),detailExtension:r.extension&&r.extension.name,detailDuration:h,type:c},i||{},a),duration:l,journeyId:r._getTelemetryJourneyId()})}),r._creationState)}))),delete u[n],h}};return this._creationState?gt.usingState(f,this._creationState):f()},t.prototype._bladeStartTelemetry=function(n,t,i){var s=this,h,c;this._bladeOpenEndTelemetry(kt.Cancel,!0);var r=this._perfData={includesExtensionLoadTime:!this.bladeDefinition},e=this.masterContainer,b=e&&e.locator,k=dt(b),d=e&&e.instanceId,l=e&&e.id,a=d||l,v=k||l,o=this.openedByInfo||{},y=o.openedByContext;o.openedBy&&(r.openedBy=pu[o.openedBy],r.isFavorite=y&&y.isFavorite(),r.openedByPartName=o.openedByPartName);a&&(r.openedByBlade=a);v&&(r.openedByBladeName=v);hr&&(r.preloadPartSettings=!0);i&&(i.autoOpenedByBlade&&(r.autoOpenedByBlade=i.autoOpenedByBlade),i.autoOpenedByPart&&(r.autoOpenedByPart=i.autoOpenedByPart));var p=this.extension,w=this.locator,u={telemetryData:r,extension:p&&p.name||si(w),locator:dt(w),assetType:t},f=function(n,t){s._markers[n]=ni.startTrace({extension:t.extension,source:fi.Shell,action:n,data:t.telemetryData,name:t.locator,assetType:t.assetType,journeyId:s._getTelemetryJourneyId()});s._markers["Menu"+n]=""};n===pt.BladeLoaded&&(h=this.widget,c=h&&h.timer,c&&(r.delayTime=c()),f(pt.BladeFullOpened,u),f(pt.BladeFullReady,u),f(pt.BladeFullRevealed,u),f(pt.BladeOpened,u),f(pt.BladeReady,u),f(pt.BladeRevealed,u),this._readyStartTime=(new Date).getTime());f(n,u)},t.prototype._rebindAsync=function(n){var t=this,r=this._rebindValidationPromise=this.awaitComposed().then((function(){if(!t._validateRebindProperties(n))return Q.reject(new i.Errors.CanceledError)})),u=function(i){vr(n,(function(n){at.setModelValue(t._shellViewModel,n,i?i[n]:undefined)}));i&&(t._journeyPath=t._buildJourneyPath())};return this._useDetailContent||this.containerWidget.clearDetailContent({callback:function(){var n=t._menu;n&&n.setDefaultId({rebinding:!0})},setPlaceholderDetailContent:!!this.bladeDefinition.menuBlade&&!this.detailContainers.length}),r.then((function(){var s=t._bindingsToExtensionViewModel&&t._bindingsToExtensionViewModel.properties.map((function(n){return n.compositionBindingDefinition})).filter((function(n){return!!n})),o,e,f;return t._lastInputsSetDeferred.reject(new i.Errors.CanceledError("New rebind started")),t._lastInputsSetDeferred=Q.defer(),o=(s||[]).filter((function(n){return!n.optional})),t._lastInputsSetProperties=at.mapSourceModelToTargetModel(n,o,1,t+""),nf(t._bindingsToExtensionViewModel,t._shellViewModel,n)||t._lastInputsSetDeferred.resolve(),t.isDisposed()?Q.reject(new i.Errors.DisposedCanceledError):r&&r!==t._rebindValidationPromise?Q.reject(new i.Errors.CanceledError("Another rebind has started")):(ai(t,"Updating blade properties.",n),e=t._callbacks,e[0].fire(n),f=t._bindingResult()&&t._bindingResult().inputsWatcherConfig,f&&ct.CompositionBinder.turnOnInputsSetSuppressionOn(f),u(undefined),t._clearEditScopeId(),t.setInputsViewModel(t._shellViewModel),(t.bladeDefinition.optionalInputs||[]).forEach((function(n){t._shellViewModel[n](undefined)})),u(n),t._setEditScope(),f&&ct.CompositionBinder.turnOnInputsSetSuppressionOff(f),e[2].fire(n),t.bladeDefinition.viewModelInputs||t._hasPermissionsDeferred.resolve(),t._lastInputsSetDeferred.promise.catch((function(){})).finally((function(){ai(t,"Inputs set promise completed.",n);t.save();e[1].fire(n)})))}))},t.prototype.onDetailContainersChanged=function(){var n=this;this.services.finder.locateAsync(this.locator).then((function(t){n._widgetsCreated&&n._initWidgetFromDefinition(t)}))},t.prototype._compose=function(n,t,i){var r=this,e,u;if(!this.isComposed&&!this._composing){if(this._composing=!0,this._loadingHandle=w.read(oi.bladeLoading,1,"blade"),this._bladeStartTelemetry(pt.BladeLoaded,i&&i.assetType,i),this._compositionDeferred.promise.then((function(){t.resolve();kr(r.widget)||r._setupCommandBarAndContextMenu();r.compositionTime=r._endTraceWithState(pt.BladeLoaded,kt.Complete)}),(function(){t.reject();r._endTraceWithState(pt.BladeLoaded,kt.Cancel)})),this.unrecoverableErrorMessage){this._composeErrorBlade(n,i,ui.ErrorUnrecoverable,this.unrecoverableErrorMessage);return}var f=this.locator,o=this.services.finder,s=this.bladeDefinition?Q(this.bladeDefinition):o.locateAsync(f),h=this.extension?Q(this.extension):o.locateAsync(gi(f));this._shouldShowPendingBlade()?(e=this._createNewBladeWidget(n,i),e.element.addClass(cr),e.options.close=function(){var n=r.services.desktop.tryCloseBlade(r.id,1);return r._bladeOpenEndTelemetry(kt.Cancel,!1),n},this._widgetsCreated=!0,this.containerWidget=e,this.widget=e.getContentWidget(),f.name===vu&&this.containerWidget.setupAsKnownMenuBlade()):(u=this.masterContainer,u&&u.bladeDefinition&&u.bladeDefinition.menuBlade&&(!u.containerWidget.isMenuBladeLoadingDetailBlade()||u.containerWidget.element.hasClass(cr))||this._loadingSignalToTopBar(n.element));s.then((function(t){return r.bladeDefinition=t,r.openedByInfo&&r.openedByInfo.openedBy===3&&!r.isPinnable()&&ni.trace({extension:r.extension&&r.extension.name||si(f),source:fi.Shell,action:pt.BladeDeepLinkedNotPinnable,name:dt(f),data:{resource:pr()}}),r.isDisposed()||(r._initWidgets(t,n,i),r._showLoadingIndicator()),h.then((function(u){if(r.extension=u,!r.isDisposed()){var f=r._validateDefinition(t);f?(r.bindings=r.bindings.concat(ct.CompositionBinder.mapInputBindingDefinitions(t.bindings,r,(function(n){n.source.scope===at.ReferenceScope.CurrentContainer&&(n.autoRebindWhenSourceDisposes=!0)}))),r._createChildrenFromDefinition(t),r.save(),r._initialized=!0,r._composeBlade(u,t)):r._composeErrorBlade(n,i,ui.ErrorInitializing,"Unable to initialize blade from definition.")}})).catch((function(t){var u=ui.ErrorLoadingExtensionAndDefinition;h.isRejected()||(u=ui.ErrorLoadingDefinition);r._composeErrorBlade(n,i,u,t)}))})).catch((function(t){var u=ui.ErrorLoadingExtensionAndDefinition;s.isRejected()||(u=ui.ErrorLoadingExtension);r._composeErrorBlade(n,i,u,t)})).finally((function(){r._loadedSignalToTopBar()}))}},t.prototype._shouldShowPendingBlade=function(){var n=this.masterContainer,t=n&&n.bladeDefinition,i=!!(t&&t.menuBlade),r=(this.flags&16)!=0;return!i&&!r&&!uf(this)},t.prototype._loadedSignalToTopBar=function(){this._loadingHintDisposer&&(this._loadingHintDisposer(),this._loadingHintDisposer=null)},t.prototype._loadingSignalToTopBar=function(n){var t=this;this._loadedSignalToTopBar();this._loadingHintDisposer=function(){n.trigger(h.default.fxloadingontopbar,{id:t.id,cancel:!0})};n.trigger(h.default.fxloadingontopbar,{id:this.id,cancel:!1})},t.prototype._showLoadingIndicator=function(){var n=this;this.widget.options.loaded(!1);this._hasPermissionsDeferred=Q.defer();Q.allSettled([this._hasPermissionsDeferred.promise,this._compositionDeferred.promise]).finally((function(){n.widget.options.loaded(!0);n._widgetReadyToDisplayAwaiter.resolve()}))},t.prototype._rejectPermissionsPromise=function(){this._hasPermissionsDeferred?this._hasPermissionsDeferred.reject():this.widget&&this.widget.options.loaded(!0)},t.prototype._validateRebindProperties=function(n){var t="",i=this.bladeDefinition.templateKeyInputs||[];return i.some((function(t){return!n.hasOwnProperty(t)}))?t="Properties to rebind must include all blade inputs marked as keys.":i.some((function(t){return bi(n[t])}))&&(t="Properties to rebind cannot be of Array type."),t&&bt.error("[Blade Rebind] "+t+" Rebind properties:'"+di(n)+"', Blade keys:'"+di(i)+"'."),!t},t.prototype._summaryCollapsed=function(){var o=this,i=!1,u,n,t,f,e=this.services;return(this.bladeDefinition.lenses||[]).some((function(r){return u=o.locator.withLens(r.name),n=e.finder.locate(u),n&&n.isSummary&&n.partInstances&&(i=!0,t=n.partInstances[0],f=u.withPartInstance(t.name)),i})),i?e.sharedSettings.querySetting(2,"[PartIdentityState]-"+f.toString()).then((function(n){return n?r.fromSerializableObject(n):null}),(function(){return null})).then((function(n){return n&&n.content&&n.content.collapsed!==undefined?!!n.content.collapsed:t.inline&&t.inline.options?!!t.inline.options.collapsed:null})):Q(!0)},t.prototype._checkIfOpenedByReferrer=function(n,t){var i=ru.ReferrerInfo,r=n.indexOf(i)>-1,u=ii(t[i])!==undefined;return r&&u},t.prototype._composeBlade=function(n,t){var i=this,u,r;hr&&this._summaryCollapsed();!t.assetType||this.containerWidget.options.associatedWithAsset(!0);u=this.services.desktop;r=this._journey=u.getActiveJourney();this._setupViewModel();t.editScopeType&&r&&r.observeEditScopeChanges(this,{editScopeId:this.editScopeId,ownerType:this.locator.type,ownerLocatable:this,disposeOnSelectionChange:!1});this._isOpenedByReferrer(this._checkIfOpenedByReferrer(t.optionalInputs||[],this._shellViewModel));this._setupInputBindings();this._setupExtensionViewModel();this._setupUnauthorizedListener();this._setupPreviewListener(n,t);this._trackAssetIdChange();this._waitForNoticeIfAny(t.waitForInputsSet).then((function(n){n&&i._composeAndRestoreLayout().then((function(){i.detailContainers.forEach((function(n){n.notifyContainer(i)}));i.masterContainer&&i.masterContainer.notifyContainer(i);du(i,i.extension,t);i.save();i.actionBar?i.actionBar.awaitComposed().then((function(){i._compositionDeferred.resolve()})):i._compositionDeferred.resolve()}),(function(){i._compositionDeferred.reject()}))}));this.onRebind();this.containerWidget.bladeDefinitionLoaded=!0;this.containerWidget.trigger(h.default.fxbladerepos)},t.prototype._waitForNoticeIfAny=function(n){var t=this;return n?this.await(3).then((function(){if(li(t._extensionViewModel))return!1;var n=ki(t._extensionViewModel.container._msPortalFxNotice),i=li(n);return i||(t._renderNotice(n),t._compositionDeferred.resolve()),i})):Q(!0)},t.prototype._buildJourneyPath=function(){var r=this,n=this.masterContainer,u=n&&n.journeyPath||[],t={model:{}};return(this.masterInputKeys||[]).forEach((function(n){t.model[n]=ii(r._shellViewModel[n])})),u.concat([st.getBladeOpenerJourneyPathSegment(this),i.toSortedString(t),this.locator.toString(),])},t.prototype._createNewBladeWidget=function(n,t){var u,i;return t=t||{},u=new k.ViewModel(this.id,this.widgetState(),{name:this.locator.name,extensionName:si(this.locator)}),u.asSubJourney=(this.flags&8)!=0,i=new k.Widget(o(r.createElement("section")),u),t.index>=0?n.insertChild(i,t.index):n.addChild(i),i},t.prototype._initWidgets=function(n,t,r){var k,tt,v,it;r=r||{};var u,f,h=null,o=null,c=this.masterContainer,s=c&&c.containerWidget,rt=s&&s.options,l=c&&c.bladeDefinition,y=this._useDetailContent||!!(l&&l.menuBlade),ut=n.style===12,w=!!n.menuBlade,b=(this.flags&16)!=0,e=this._useDetailContent=y&&wr(n)||b,et=y&&!e;if(this._autoOpenSettingsDisabled=e,(b||e)&&(o=new d.ViewModel(this.id),o.displayState=s.options.displayState,o.applyViewSettings(this.widgetState()),u=s,u.options.isMenuBlade(!0),i.isFeatureEnabled("pinnable_default_off")&&(u.options.pinEnabled(!1),u.options.pinVisible(!1))),b?f=u.openBladeInPlace(this,o):e?f=u.setDetailContent(o):this._widgetsCreated?(u=this.containerWidget,h=u.options,f=this.widget):(u=this._createNewBladeWidget(t,r),h=u.options,f=u.getContentWidget()),this._widgetsCreated=!0,this.containerWidget=u,this.widget=f,k=this.services.desktop.getActiveJourney(),k){var st=k.blades,g=st[st.length-2],a=g&&g.masterContainer,ht=a&&a.containerWidget,nt=ht&&ht.options,ct=a&&a.bladeDefinition,lt=ct&&ct.menuBlade,at=lt&&wr(g.bladeDefinition)&&!nt.useActivationStyle,vt=rt&&rt.fullWidthExtensionOptOut,yt=nt&&nt.fullWidthExtensionOptOut;(!vt&&et||!yt&&at)&&h&&(h.asSubJourney=!0)}f.options.isV2Blade(er(n));e?f.element.data(ft.CompositionInstanceDataName,this):u.element.data(ft.CompositionInstanceDataName,this);this._attachEventHandlers(u,f,e,et,y,s);this.widgetState(f.saveViewSettings());tt=u.options.fullWidthExtensionOptOut=!i.isFeatureEnabled("noextensionoptout")&&si(this.locator).toLowerCase()in i.getEnvironmentValue("fullWidthOptOutExtensions");ut&&f.options.bladeStyle(12);v=ut;v||(v=(e||w)&&!tt);it=this._perfData.initialDisplayState=v?2:n.initialDisplayState;u.options.maximizeOrRestoreEnabled(it!==2);ot.applyDisplayState(n,u.options.displayState,e,l&&l.initialDisplayState,it,tt);this._initContainerWidgetFromDefinition(n,u.options);this._initWidgetFromDefinition(n);e&&n.initialDisplayState===1&&f.setContentWidth();u.options.showBladeIcon(!!n.assetType);f.initializeLayout();u.initializeLayout({setPlaceholderDetailContent:w&&!this.detailContainers.length,callback:function(n){w&&n.addClass(au)}});p.FocusHandler.Instance.registerContainerForFocus(f.element.findByClassName("fxs-blade-content")[0]);f.options.locked(n.locked||!1)},t.prototype._initContainerWidgetFromDefinition=function(){var i=this._useDetailContent,n=this.masterContainer,t=n&&n.bladeDefinition;t&&t.menuBlade&&!i&&n.containerWidget.options.displayState(1)},t.prototype._initWidgetFromDefinition=function(n){var r=li(n.width)?1:n.width,t,i;if(this.containerWidget.options.useActivationStyle=!!n.activationStyle,t=this.widget.options,t.bladeWidth(r),t.bladeStyle(n.style),this.flags&1){t.displayState(1);this.containerWidget.setContextPaneWidth(n.contextPaneWidth);i=void 0;switch(n.style){case 12:i=12;break;case 6:case 8:case 4:case 3:case 9:case 10:i=4;break;default:i=7}t.bladeStyle(i)}t.displayState()!==2&&this._widgetReadyToDisplayAwaiter.resolve()},t.prototype._composeErrorBlade=function(n,t,r,u){var s,o,c,f,l;if(!this.isDisposed()){var e=this.locator,a=this.bladeDefinition||{name:e.name,lenses:[],locked:!0},v=e&&gi(e),y=v&&tu.getWindowId(v);u=i.getLogFriendlyMessage(u);ni.trace({extension:y,source:fi.Shell,action:pt.BladeLoadErrored,actionModifier:ui[r],name:dt(e),data:{details:u},journeyId:this._getTelemetryJourneyId()});s="Blade '"+this+"' has been turned to error mode. Details: "+(u||"N/A");bt.error(s);this._widgetsCreated||this._initWidgets(a,n,t);o=this.containerWidget;c=o.options;c.locked(!0);c.titleImageUri(undefined);f=this.widget.options;nu(f);f.title(wi.error);f.disabled(!0);l=e&&e.name;f.disabledMessageTitle(l&&wi.errorTitleFormat.format(l));f.disabledMessageSubtitle(y);ur(o,f,a);this._compositionDeferred.reject(new i.Errors.CanceledError(s));this._rejectPermissionsPromise();this._loadingHandle&&(this._loadingHandle(),this._loadingHandle=null);this._loadingErrHandle=w.read(oi.bladeError.format(this.title()||oi.unknown),1,"blade");o.bladeDefinitionLoaded=!0;o.trigger(h.default.fxbladerepos)}},t.prototype.disableForAssetDeleted=function(n,t){var e,r,u,f,o,i;if(this._useDetailContent){this.masterContainer.disableForAssetDeleted(n,t);return}if(e="Blade "+this+" "+(n?"closed":"disabled")+" because asset deleted. Reason: "+t,n)bt.warning(e),this.services.desktop.forceCloseBlade(this.id);else{for(this._disabled=!0,this._releaseResources(),r=this.children.length-1;r>=0;r--)this.removeChild(this.children[r]);u=this.containerWidget;f=u&&u.options;f&&(o=ci.deletedTitle,f.disabled(!0),f.titleImageUri(undefined),i=this.widget.options,nu(i),i.title(o),i.disabledMessageTitle(o),i.disabledMessageSubtitle(ci.deletedSubTitle),ur(u,i,this.bladeDefinition));this.bindings=[];this._compositionDeferred.reject();this._rejectPermissionsPromise();bt.warning(e)}this.save()},t.prototype.resetLayout=function(n){var t=this;return this.awaitComposed().then((function(){var i=t.detailContainers[0],r,u,f,e;return i&&i._useDetailContent?i.resetLayout(n):(r=t.services,u=r.desktop,n?f=Q(6):(e=new s.MessageBox(wi.resetConfirmationTitle,wi.resetConfirmationText,4),f=r.diContainer.getAsync(s.DialogManager).then((function(n){return n.showDialog(o(t.widget.getForm()),e,t.locator)}))),f.then((function(n){var i,r;if(n===6){if(i=u.discardEditsOfBlade(t,{includeSelf:!0,includeDescendants:!0,force:!0}),!i.successful){bt.error("Unexpectedly failed to discard changes on the blade with id: '"+t.id+"'");return}if(r=u.closeChildBlades(t),!r.successful){bt.error("Unexpectedly failed to close child blades of the blade with id: '"+t.id+"'");return}t.widget.options.loaded(!1);t.children.forEach((function(n){n.children.forEach((function(n){n.clearIdentitySettings()}))}));t.removeChildren();t._createChildrenFromDefinition(t.bladeDefinition);t._removeRedirectParts();t._composeChildren();t.save();t.widget.options.loaded(!0)}})))}))},t.prototype._setupCommandBarAndContextMenu=function(){var n=this.widget.options,i=this.bladeDefinition,t;yr(this._commandBarLifetime);t=this._commandBarLifetime=this.createChildLifetime();tt.create(t,this,this.services,this._shellViewModel);this._composeShellCommands(n.contextMenu.menuItems,i.locked,n.displayState);t.registerForDispose((function(){n.commandBar.menuItems([]);n.contextMenu.menuItems([])}))},t.prototype._setupInputBindings=function(){var n=this;ct.CompositionBinder.setupPropertyBindings(this,this.getInputPropertyBindings(),this.bindings);this.getInputPropertyBindings().addPropertyChangedHandler((function(){n.save()}))},t.prototype.getComposedParts=function(){return this._partAwaiter.resolvedCompositions},t.prototype.getParts=function(){return i.mapMany(this.children,(function(n){return n.children}))},t.prototype.getInputPropertyBindings=function(){return this._inputPropertyBindings||(this._inputPropertyBindings=new at.PropertyBindings(this+"",this._shellViewModel)),this._inputPropertyBindings},t.prototype.awaitComposedPart=function(n,t){return this._partAwaiter.await(n,t)},t.prototype.notifyPartComposed=function(n){this._partAwaiter.resolve(n)},t.prototype.awaitWidgetReadyToDisplay=function(){return this._widgetReadyToDisplayAwaiter.promise},t.prototype.getWaitingCompositions=function(){return this._partAwaiter.waitingCompositions},t.prototype.await=function(t){switch(t){case 3:return this._lastInputsSetDeferred.promise}return n.prototype.await.call(this,t)},t.prototype.dispose=function(t){var r=this,u=this.locator,f=this.extension,i=pt.BladeClosed;window.removeEventListener("beforeunload",this._beforePageUnload);vr(this._markers,(function(n,t){t&&r._endTraceWithState(n,kt.Cancel)}));this._markers[i]=ni.startTrace({extension:f&&f.name||si(u),source:fi.Shell,action:i,name:dt(u),journeyId:this._getTelemetryJourneyId()});this._releaseResources(t);this.masterContainer&&!this.masterContainer.isDisposed()&&this.masterPartId&&this.masterContainer.awaitComposedPart(null,ft.getIdMatchFunc(this.masterPartId)).done((function(n){n.notifyDetailBladeClosed(r)}));n.prototype.dispose.call(this,t);this._endTraceWithState(i,kt.Complete);[this._loadingHandle,this._loadedHandle,this._loadingErrHandle].forEach((function(n){return n&&n()}));this._loadingHandle=this._loadedHandle=this._loadingErrHandle=null;w.read(oi.bladeClosed.format(this.title()||""),1,"blade");this._loadedSignalToTopBar()},t.prototype._releaseResources=function(n){yr(this._disposablesEvents);this._disposablesEvents=[];[this._inputPropertyBindings,this._bindingsToBladeWidgetModel,this._bindingsToExtensionViewModel].forEach((function(n){n&&(n.unbind(),n=null)}));n||this._disposeEditScopes();this._extensionViewModel&&this.extension&&(i.disposeViewModelProperties(this._extensionViewModel),this.extension.releaseViewModel(this._extensionViewModel),this._extensionViewModel=null);this._callbacks.forEach((function(n){n.empty()}));this._journey=null},t.prototype.awaitContainer=function(n,t){return this._containerAwaiter.await(n,t)},t.prototype.onInvocationStarted=function(){this._autoOpenSettingsDisabled=!0},t.prototype.notifyContainer=function(n){this._containerAwaiter.resolve(n)},t.prototype.getDiagnosticsData=function(){return o.extend(n.prototype.getDiagnosticsData.call(this),{title:yi(this.title),detailBlades:this.detailContainers.map((function(n){return n.id})),bindings:ct.CompositionBinder.mapBindingsToFriendlyObjects(this.bindings)})},t.prototype.getAssetId=function(){var i=this;if(!this.bladeDefinition||!this.bladeDefinition.assetIdInputProperty)return Q.reject();var r=function(n){var t=i._tryGetAssetIdFromBinding();t&&t.exists?n.resolve(ii(t.value)):n.reject()},n=this._bindingResult,u=function(t){n().allInputsSet()?r(t):n().allInputsSet.subscribe(i,(function(n){n&&!t.promise.isFulfilled()&&r(t)}))},t=Q.defer();return n()?u(t):n.subscribe(this,(function(n){n&&!t.promise.isFulfilled()&&u(t)})),t.promise},t.prototype.setViewModelForTemplateOrMenuBlade=function(n){this._bladeViewModelDeferred.resolve(n)},t.prototype.setInputsSetPromise=function(n){var t=this;n.finally((function(){t._initialOnInputsSetDeferred.resolve();t._lastInputsSetDeferred.resolve()}))},t.prototype._trackAssetIdChange=function(){var n=this,t;this.bladeDefinition.menuBlade?(t=this.children.mapMany((function(n){return n.children})).first(),ti(this,(function(){n.assetId(t.assetId())}))):ft.bladeImplementedWithVirtualPart(this.bladeDefinition)?ti(this,(function(){var t=dr(n.bladeDefinition,n._shellViewModel,n.locator.toString());t.exists&&n.assetId(t.value)})):ti(this,(function(){var i=n._bindingResult(),t;i&&i.allInputsSet()&&(t=n._tryGetAssetIdFromBinding(),t&&t.exists&&n.assetId(ii(t.value)))}))},t.prototype._tryGetAssetIdFromBinding=function(){var t=this,n=this._bindingResult().propertyBindings.properties.first((function(n){return n.targetProperty===t.bladeDefinition.assetIdInputProperty}));return n?at.getModelValue(n.sourceModel,n.sourceProperty):null},t.prototype._setupViewModel=function(){var n=this;(this.bladeDefinition.outputs||[]).forEach((function(t){n._shellViewModel.hasOwnProperty(t)||(n._shellViewModel[t]=wt(undefined))}));this._setEditScope()},t.prototype._setEditScope=function(){if(this.bladeDefinition.editScopeType){var n=this._journey&&this._journey.ambientSettings.getItem(this.journeyPath);if(n&&n.value&&n.value.editScope)this.editScopeId(n.value.editScope.editScopeId);else{this.editScopeId(i.getUniqueId());this.services.diContainer.get(b.EditScopeManager).onEditScopeCreated(this.editScopeId())}this._shellViewModel[ft.EditScopeIdPropertyName]||(this._shellViewModel[ft.EditScopeIdPropertyName]=wt());this._shellViewModel[ft.EditScopeIdPropertyName](this.editScopeId())}},t.prototype._updateForHasPermissions=function(n){var t=this;return this._extensionViewModelPromise.then((function(){var r,i;t.isDisposed()?bt.warning("Blade '"+t.locator.toString()+"' disposed when checking permissions."):(r=t._extensionViewModel.container,n?(r.unauthorizedMessage(null),t._hasPermissionsDeferred.resolve()):(i=r.unauthorized(),i&&i.finally?i.finally((function(){t._hasPermissionsDeferred.reject()})):t._hasPermissionsDeferred.reject()))}))},t.prototype._setupExtensionViewModel=function(){var n=this,h=this.widget,f,r,u=this.bladeDefinition,s=ft.bladeImplementedWithVirtualPart(u),l=function(t){return f=n._createBindViewModelConfiguration(t),r=ct.CompositionBinder.createBindViewModelResult(f)};if(u.viewModelName||s){var t=this+"-["+u.viewModelName+"]",o=u.viewModelInputs,a=Q(null);o&&(l(t),r.inputsWatcherConfig&&(a=ct.CompositionBinder.loadOnInputsSetParameters(r.inputsWatcherConfig)));this._extensionViewModelPromise=a.then((function(t){o&&(n._earlyOnInputsSet=!!t);var i=gt.provideContext((function(){return n._creationState=gt.getState(),s?n._bladeViewModelDeferred.promise:n.extension.getViewModel(u.viewModelLocator||u.viewModelName,68,{onInputsSetParameters:t})}),tr.Blade,fr(n));return(gt.provideContext((function(){n._masterBladeState=gt.getState()}),tr.Blade,n.masterContainer?fr(n.masterContainer):null),t)?i.then((function(n){return ct.CompositionBinder.notifyOnInputsSetCalled(r.inputsWatcherConfig,t,n.onInputsSetPromise),n})):i})).then((function(h){var g=n+"-[WidgetModel]",a=h.content(),w,b,y;if(n._extensionViewModel=h,n.isDisposed())return n._releaseResources(),Q.reject(new i.Errors.DisposedCanceledError);if(!n.isDisabled){ti(n,(function(){var t=h.container.notFoundMessage();i.isNullOrWhiteSpace(t)||n._renderNotice({noticeTitle:t,noticeImageType:3,bladeTitle:c.Container.notFound,bladeSubtitle:"",shouldDisableBlade:!0})}));o||s||(n._initialOnInputsSetDeferred.resolve(),n._lastInputsSetDeferred.resolve());o?(f||l(t),f.bindableTarget.viewModel=h,r.inputsWatcherConfig&&ct.CompositionBinder.setupAllInputsSetWatcherFromExtendedConfig(r.inputsWatcherConfig),n._bindingsToExtensionViewModel=r.propertyBindings,n._bindingResult(r)):n._hasPermissionsDeferred.resolve();var nt=n.containerWidget.options,v=n.widget.options,p=n._bindingsToBladeWidgetModel=new at.PropertyBindings(g,{title:v.title,subtitle:v.subtitle,titleSuffix:v.titleSuffix,subtitleSuffix:v.subtitleSuffix,description:v.description,helpUri:v.helpUri,icon:v.icon,titleImageUri:nt.titleImageUri,contentState:v.contentState,contentStateDisplayText:v.contentStateDisplayText});ti(n,(function(){v.shieldType(n.shieldType())}));ti(n,(function(){v.isUiBlocked(n.uiBlockers().some((function(n){return n()})))}));h.container.helpContentUri.subscribeAndRun(n,n.helpContentUri);w=void 0;b=void 0;er(u)?(w=gu(n,a),b=null):(w=a,b=d.defaultSvg);y=k.widgetProperties;ri(p,t,a,y.title,n.title,k.getDefaultTitle(n.locator.name));ri(p,t,a,y.subtitle,n.subtitle,"");ri(p,t,a,y.titleSuffix,n.titleSuffix,"","titleSuffix",!0);ri(p,t,a,y.subtitleSuffix,n.subtitleSuffix,"","subtitleSuffix",!0);ri(p,t,a,y.description,n.description,"");ri(p,t,a,y.helpUri,n.helpUri,"");ri(p,t,w,y.icon,n.icon,b);ri(p,t,a,y.titleImageUri,n.titleImageUri,undefined);a.statusBar?n._onStatusBarClick=tf(n,a.statusBar,n.widget.options,n._isOpenedByReferrer):(ri(p,t,a,y.contentState,e.observable(0),0),ri(p,t,a,y.contentStateDisplayText,e.observable(""),""));ti(n,(function(){var n=v.icon(),t=er(u)?!n:i.deepEquals(n,d.defaultSvg);v.hasIcon(!t)}))}return h})).catch((function(t){var r="Unable to get extension view model for blade '"+n.locator.toString()+"'. Error: "+i.getLogFriendlyMessage(t);return vi.Error.isBaseOf(t)&&t.errorLevel===0||bt.error(r),h.options.title(k.getDefaultTitle(n.locator.name)),n._hasPermissionsDeferred.resolve(),Q.reject(new vi.CanceledError(r))}))}else h.options.title(k.getDefaultTitle(this.locator.name)),this._initialOnInputsSetDeferred.resolve(),this._hasPermissionsDeferred.resolve()},t.prototype._createBindViewModelConfiguration=function(n){var t=this;return{bindableTarget:{viewModelName:n},inputs:this.bladeDefinition.viewModelInputs,referenceComposition:this,inputsSetCalled:function(n,i){i.finally((function(){(o.isEmptyObject(t._lastInputsSetProperties)||ft.deepSubset(n,t._lastInputsSetProperties))&&t._lastInputsSetDeferred.resolve();t._initialOnInputsSetDeferred.resolve()}))},customInputBindingValidator:function(n){if(n.valuesFrom[0].referenceType!==1&&n.valuesFrom[0].referenceType!==5&&!n.optional)return"Blade view model binding can only use 'BladeInput' and 'Constant' reference types."},beforeViewModelPropertyUpdate:function(n){var i=t.bladeDefinition,r;return((i.optionalInputs||[]).forEach((function(t){n[t]===undefined&&delete n[t]})),i.permissions&&!ft.bladeImplementedWithVirtualPart(i))?(r=t.locator.toString(),vt.checkPermissions(i.permissions,eu.All,n,i.assetType,t.extension.name,t.services,r).then((function(n){return t._updateForHasPermissions(n).then(null,(function(n){bt.error(n)})),n}))):(t._hasPermissionsDeferred.resolve(),Q(!0))}}},t.prototype._setupUnauthorizedListener=function(){var n=this,t=this._extensionViewModelPromise;t&&t.done((function(t){var r=t.container;r.unauthorizedMessage.subscribeAndRun(n,(function(t){if(!li(t)){var u=n.widget.options,e=u.title()||ci.unauthorizedMessage,o=u.subtitle(),f=i.isObject(t),r=f?t:{},s=!f&&t!==i.Resources.Strings.ViewModels.Container.unauthorizedText?t:r.noticeDescription||ci.unauthorizedDescription;n._renderNotice({noticeHeader:r.noticeHeader||ci.unauthorizedHeader,noticeTitle:r.noticeTitle||ci.unauthorizedMessage,noticeDescription:s,noticeCallToActionText:r.noticeCallToActionText||"",noticeCallToActionUri:r.noticeCallToActionUri||"",noticeImageType:3,bladeTitle:e,bladeSubtitle:o,shouldDisableBlade:!0})}}))}))},t.prototype._setupPreviewListener=function(n,t){var u=this,i=this.containerWidget.options,r;n.isPreview()?i.showPreviewTag(!0):t.assetType?(r=this.services.assetTypeService,cu(r.assetTypesComplete,(function(){var u=r.getAssetType(n.name,t.assetType);u&&i.showPreviewTag(u.isPreview)}))):this._extensionViewModelPromise&&this._extensionViewModelPromise.then((function(n){var t=n.container;t.preview.subscribe(u,i.showPreviewTag);i.showPreviewTag(t.preview())}))},t.prototype._renderNotice=function(n){var r,u,f,t,i;if(!ft.bladeImplementedWithVirtualPart(this.bladeDefinition))for(r=this.children.length-1;r>=0;r--)this.removeChild(this.children[r]);u=this.containerWidget;f=u&&u.options;f&&(t=this.widget.options,t.contentState(0),t.contentStateDisplayText(""),n.bladeTitle!==undefined&&t.title(n.bladeTitle),n.bladeSubtitle!==undefined&&t.subtitle(n.bladeSubtitle),t.titleSuffix(""),t.subtitleSuffix(""),ur(u,t,this.bladeDefinition),i=new hu(this.widget.ltm||this),i.header(n.noticeHeader),i.title(n.noticeTitle),i.description(n.noticeDescription),i.imageType(n.noticeImageType),i.callToActionText(n.noticeCallToActionText),i.callToActionUri(n.noticeCallToActionUri),t.unauthorizedNoticeVm(i));n.shouldDisableBlade&&(this._disabled=!0,this.bindings=[],this._releaseResources());this._compositionDeferred.resolve()},t.prototype._disposeEditScopes=function(){var r=this,i=this.editScopeId(),n,t;if(i)this.services.diContainer.get(b.EditScopeManager).onEditScopeDisposed(i);n=this._journey;n&&(t=this.journeyPath,n.ambientSettings.getItemsInPath(t).forEach((function(n){if(n.value&&n.value.editScope)r.services.diContainer.get(b.EditScopeManager).onEditScopeDisposed(n.value.editScope.editScopeId)})),n.ambientSettings.removeItemsInPath(t))},t.prototype._clearEditScopeId=function(){if(this.bladeDefinition.editScopeType){var n=this.editScopeId(),t=n&&this.services.diContainer.get(b.EditScopeManager).getStateObservable(n);if(t&&t()===0)this.services.diContainer.get(b.EditScopeManager).onEditScopeDisposed(n);this.editScopeId(undefined);this._shellViewModel[ft.EditScopeIdPropertyName](undefined)}},t.prototype._createChildrenFromDefinition=function(n){var i=this,t;n.lenses&&(t=[],n.lenses.forEach((function(n){var u=i.locator.withLens(n.name),r=lt.create(i.services,u);n.isSummary?t.unshift(r):t.push(r)})),this.addChildren(t))},t.prototype._removeRedirectParts=function(){var n=this,t=this.children.filter((function(t){var i=t.children.filter((function(t){var i={},r=n.services.finder.tryLocate(t.locator,i),u=i.value;return r&&!!u.redirectMode})),r=t.children.length&&i.length===t.children.length;return i.forEach((function(n){t.removeChild(n)})),r}));t.forEach((function(t){n.removeChild(t)}))},t.prototype._composeChildren=function(n){var t=this;n===void 0&&(n=this.children);var r=[],f=[],i=[],e=[],u=[],o=[],h=[],s=this._summaryCollapsed();n&&n.length&&n.forEach((function(c,l){var a=Q.defer(),y=a.promise,v=!l;v?n[l].awaitChildrenAboveTheFoldOnInputsSetsResolved().finally((function(){a.resolve()})):n[l-1].awaitChildrenOnInputsSetsResolved().finally((function(){a.resolve()}));pi.setTimeout(a.resolve,12e3);h.push(a);s.then((function(n){t._bladeSummaryCollapsed=n;c.compose(t.widget,{delayLoadPromise:y,noDelayOnFirstPart:v,delayLoad:function(){return!1}});r.push(c.awaitComposed());i.push(c.await(3));u.push(c.await(0));c.children.concat([c]).forEach((function(n){r.push(n.awaitComposed());i.push(n.await(3));u.push(n.await(0));n.getLoadDelayed()||(f.push(n.awaitComposed()),e.push(n.await(3)),o.push(n.await(0)))}))}))}));s.finally((function(){var c=function(n,i){return Q.all(n).then((function(){t._traceBladeComplete(i,[],t._bladeOpenEndTelemetry,!1)}))},n=function(n,i,r,u){Q.allSettled(n).then((function(n){t._traceBladeComplete(i,n,r,u)}))},s,h;c(f,!1);c(r,!0).finally((function(){t._composing=!1;t.save()}));s=t._bladeReadyEndTelemetry;n(e,!1,s);n(i,!0,s);Q.all(i).then((function(){t._loadingHandle&&(t._loadingHandle(),t._loadingHandle=null);t._loadedHandle=w.read(oi.bladeReady.format(t.title()||""),1,"blade")}));h=t._bladeRevealedEndTelemetry;n(o,!1,h,!0);n(u,!0,h,!0)}))},t.prototype.getPerfData=function(){return i.extend2(this._perfData,this._menu&&this._menu.getTelemetryInfo())},t.prototype._traceBladeComplete=function(n,t,i,r){var u,f;this._initializeTelemetryDetails(t,r);u=this.extension;this._perfData.extVersion=u&&u.extension&&u.extension.getVersion();f=this._perfData;i.call(this,f.rejectedPromises?kt.Cancel:kt.Complete,n,f)},t.prototype._initializeTelemetryDetails=function(n,t){var u=n.filter((function(n){return n.state==="rejected"})),i=this._perfData,r;t&&(i.anyPartContentRevealedCalled=n.some((function(n){return!!n.value})));r=this.bladeDefinition;i.lockedBlade=!!r.locked;i.useDetailContent=this._useDetailContent;i.bladeType=bu[ft.getBladeType(r)];i.bladeWidth=i.initialDisplayState===2?"Fullscreen":wu[r.width];i.inContextPane=!!(this.flags&1);i.resource=pr();u.length===0?i.earlyOnInputsSetBlade=this._earlyOnInputsSet:i.rejectedPromises=u.length},t.prototype._composeAndRestoreLayout=function(){var n=this,u=this.containerWidget,t,r,f;return this._removeRedirectParts(),this._composeChildren(),t=Q(),r=this.bladeDefinition.actionBar,!this._rebinding&&r&&(f=this.locator.withBladeActionBar(r.name),t=i.tryImmediateResolve(i.require("MsPortalImpl/UI/Compositions/UI.Composition.BladeActionBar"),(function(t){var i=n.actionBar=t.create(n.services,f);i.parent=n;i.compose(n.widget);n.registerForDispose(n.actionBar)}))),u.options.displayState()===2&&u.refreshDisplayState(),t},t.prototype._getCommands=function(){if(!this.isComposed||!this.widget)throw new Error("Blade '"+this+"' needs to be composed before retrieving its commands.");return this.widget.options.commandBar.menuItems()},t.prototype._attachEventHandlers=function(n,t,r,u,f,e){var s=this,y=n.element,v=t.element,c=n.options,l;if(!r){v.on(h.default.fxregistermenu,(function(t,r){var e=s._defaultMenuItemId,l=s.masterContainer,h,u,f;!e&&l.getCompositionType()===ft.CompositionType.Startboard&&i.startsWith(s.masterInvocationProperty,"container.")&&(h=l.getComposedParts().first(ft.getIdMatchFunc(s.masterPartId)),e=h&&h.defaultMenuItemId);u=a.ActionModifier.Default;f=dt(s.locator);r.onItemClick((function(n,t){ni.trace({name:n,action:"MenuItemClick",actionModifier:u,source:fi.Blade,journeyId:s._getTelemetryJourneyId(),data:o.extend({blade:f,type:r.getResourceType()||s.assetType},t)})}));r.setDefaultId({recommendedId:s._defaultMenuItemId||e});r.onSearchMiss((function(n){gt.usingState((function(){ni.trace({name:f,action:"MenuBladeSearchMiss",actionModifier:u,source:fi.Blade,data:o.extend({blade:f,type:r.getResourceType()||s.assetType},n),journeyId:s._getTelemetryJourneyId()})}),s._creationState)}));s.initialOnInputsSetPromise().finally((function(){var n=r.getResourceType()||s.assetType;gt.usingState((function(){ni.trace({action:"MenuBladeInfo",actionModifier:u,source:fi.Blade,data:o.extend({blade:dt(s.locator),type:n},r.getTelemetryInfo()),journeyId:s._getTelemetryJourneyId()})}),s._creationState);n&&c.associatedWithAsset(!0)}));ti(s,(function(){n.options.titleSuffix(r.selectedItemText())}));s._menu=r}));c.close=function(){var t=s.services.desktop,i=t.tryCloseBlade(s.id,1),n,r;return i&&u&&(n=t.getActiveJourney().blades,r=n[n.length-1],r._menu.selectDefaultItem()),s._bladeOpenEndTelemetry(kt.Cancel,c.loaded()),i};c.pinblade=function(){l&&l.dispose();l=s.createChildLifetime();var t=new rt.Pin(l,s.services);t.bind(new it.CompositionInstanceCommandContext(n.element[0],function(){return Q(n.getContentWidget())},s));t.execute(!1)};f&&e&&e.clearDetailContent({clearPlaceholderDetailContent:!0});c.maximizeOrRestore=function(t,i){var u=n.options.displayState(),r;if(!i||!i.forceMaximize||u!==2){switch(u){case 2:r=rt.getDisplayStateCommand(1);break;case 1:r=rt.getDisplayStateCommand(2)}r.activate();r.bind(new it.CompositionInstanceCommandContext(n.element[0],function(){return Q(n.getContentWidget())},s));r.execute(!1)}}}t.options.commandBar.itemSelected=function(n,r){var u=r.item,e,o,f;u&&u.enabled()&&!u.unauthorized()&&(e=r.popupTarget,o=e?{getForm:function(){return e},showForm:i.noop,hideForm:i.noop}:t,u.bind(new it.CompositionInstanceCommandContext(t.element[0],function(){return Q(o)},s)),u.execute(!1),f=r.item.commandDefinition,f&&f.details&&gr(s,(function(n){return n.masterCommandName===f.name})))};this._disposablesEvents.push(v.setEvents([nt.Widget.viewSettingsChanged,function(n,t){s.widgetState(t);s.save(1);n.stopPropagation()},],[h.default.fxbladestatusbarclicked,function(){s._onStatusBarClick&&s._onStatusBarClick()},]),y.setEvents([h.default.fxensurebladevisible,function(n,t){gr(s,(function(n){return!n.masterCommandName&&n.masterPartId===t.masterPartId}))},],[h.default.fxsummarycollapsed,function(){return s._bladeSummaryCollapsed},]))},t.prototype._composeShellCommands=function(n,t,i){var e=[],o=this.services,r=this.containerWidget.options,u,f;this.isPinnable()&&(u=new rt.Pin(this,o),r.pinVisible(!0),f=this.bladeDefinition,f&&f.hasOnPinMethod?this.getOnPinFunction().then((function(n){n&&(u.activate(),r.pinEnabled(!0))})):(u.activate(),r.pinEnabled(!0)));e.push(rt.getDisplayStateCommand(1),new rt.ResetLayout(this,t,i,o));ar.arrayPushAll(n,e)},t.prototype._validateDefinition=function(n){var u=this,t=!0,i=[],r="A blade cannot be the owner of an edit scope and also receive an edit scope id from an external source.";return n.assetType&&!n.assetIdInputProperty?(i.push("'assetIdInputProperty' is required if 'assetType' is defined on blade definition."),t=!1):ct.CompositionBinder.modelHasProperties(this+"",n.inputs,this.getViewModel())?n.inputs&&n.outputs&&(t=!n.inputs.some((function(t){var r=n.outputs.indexOf(t)>=0;return r&&i.push("Property '"+t+"' cannot be marked as input and output."),r}))):t=!1,t=t&&ct.CompositionBinder.validateInputBindings(this,n.bindings,i,(function(t){return t.valuesFrom[0].referenceType===1?"Blade bindings cannot reference BladeInputs.":bi(n.inputs)&&n.inputs.indexOf(t.property)>=0?"Blade bindings that target a blade input are not supported. Inputs: '"+yi(n.inputs)+"'. Bindings: '"+yi(n.bindings)+"'.":!!n.editScopeType&&t.property===ft.EditScopeIdPropertyName?"Declaring an 'editScopeType' and an input binding with '"+ft.EditScopeIdPropertyName+"' as a target property is not supported. "+r+" Bindings: "+di(u.bindings):void 0})),t&&!!n.editScopeType&&bi(this.masterInputKeys)&&this.masterInputKeys.indexOf(ft.EditScopeIdPropertyName)>=0&&(t=!1,i.push("Declaring an 'editScopeType' and receiving an '"+ft.EditScopeIdPropertyName+"' from invocation values is not supported. "+r+(" Invocation Properties: "+di(this.masterInputKeys)+"."))),t&&ct.CompositionBinder.modelHasPropertiesWithValue(this+"",n.templateKeyInputs,this.getViewModel()),i.length&&bt.error(i[0]+" Blade:'"+this.locator+"'."),t},t.prototype._getTelemetryJourneyId=function(){var n=this._journey||this.services.desktop.getActiveJourney();return n&&n.id},t})(et.Instance);t.Instance=nr}));
define("MsPortalImpl/UI/Compositions/UI.Composition.Journey",["require","exports","f","o","ko","MsPortalImpl/Base/Base.HierarchyMap","MsPortalImpl/Services/Services.EditScopeManagement","MsPortalImpl/UI/Compositions/UI.Composition","MsPortalImpl/UI/Compositions/UI.Composition.Base","MsPortalImpl/UI/UI.DesktopManager","MsPortalImpl/Widgets/Widgets.Journey","MsPortalImpl/UI/Compositions/UI.Composition.Blade"],(function(n,t,i,r,u,f,e,o,s,h,c){"use strict";function l(n,t){return n.id===t.id}function y(n,t){return new a(n,t)}var v,a;r.defineProperty(t,"__esModule",{value:!0});v=o.CompositionType;a=(function(n){function t(t,i,r,e,o,s){var h=n.call(this,"Journey",t,null,r,e,o)||this;return h.journeyBlades=u.observableArray(),h.lastModifiedTime=u.observable(Date.now()),h._store=8,h.originTile=i,h._updateBladesMetadata(),h._ambientSettings=s||new f.HierarchyMap,h._setupEditScopeReactor(h.originTile),h}return __extends(t,n),r.defineProperty(t.prototype,"ambientSettings",{get:function(){return this._ambientSettings},enumerable:!0,configurable:!0}),t.prototype.getCompositionType=function(){return v.Journey},t.prototype.getDeepLink=function(){var n=this;return this.awaitComposed().then((function(){var t=n.blades,i=t.length;return i?t[i-1].getDeepLink():n.originTile.getPartsContainer().getDeepLink()}))},t.prototype.isStartedWithContextBlade=function(){var n=this.children;return n.length>0&&!!(n[0].flags&1)},t.prototype.observeEditScopeChanges=function(n,t){this._observeEditScopeChanges(n,t,!0)},t.prototype._observeEditScopeChanges=function(n,t,i){var r=this;u.computed(n,(function(){var s=t.editScopeId&&t.editScopeId(),f,l,a,o;if(s){var y=r.services.diContainer.get(e.EditScopeManager).getStateObservable(s),v=y(),h=v===2,c=v===1||h,n=t.ownerLocatable.journeyPath,u=r._ambientSettings;c?(f=void 0,l=u.getItem(n),l?(a=l.value,a&&(o=a.editScope,o&&(o.dirty!==c||o.saving!==h)&&(u.removeItem(n),f=!0))):f=!0,f&&u.addItem(n,{type:t.ownerType,editScope:{editScopeId:s,dirty:c,saving:h,disposeOnSelectionChange:t.disposeOnSelectionChange,disposeOnJourneyDiscard:i}})):u.removeItem(n)}}))},t.prototype.removeChildAt=function(t,i){n.prototype.removeChildAt.call(this,t,i);this._updateBladesMetadata()},t.prototype._addChildrenInternal=function(t,i){n.prototype._addChildrenInternal.call(this,t,i);this._updateBladesMetadata()},t.prototype._setupEditScopeReactor=function(n){var t=this;n&&n.awaitComposed().done((function(){if(!t.isDisposed()&&n.partDefinition.editScopeType){var i=n,r={editScopeId:n.editScopeId,ownerType:n.locator.type,ownerLocatable:n,disposeOnSelectionChange:!1};t._observeEditScopeChanges(i,r,!1)}}))},t.prototype._updateBladesMetadata=function(){var t=this.journeyBlades;if(t){var u=t(),r=i.unique(this.children,l),n=[];u.forEach((function(t){var i=r.first((function(n){return l(t,n)}));i&&(n.push(t),t.subtitle(i.subtitle()),t.title(i.title()))}));n=i.pushUnique(n,r,l);t(n)}},t.prototype._compose=function(n,t){var r=this,i;n.getJourneyWidget()||(i=new c.ViewModel(this.id,function(){return r.services.desktop.portalWidget.getRootPageDisplayType()}),this.widget=new c.Widget(n.getJourneyArea(),i));t.resolve()},r.defineProperty(t.prototype,"blades",{get:function(){return this.children},enumerable:!0,configurable:!0}),t})(s.Instance);t.Instance=a;t.create=y}));
define("MsPortalImpl/UI/Compositions/UI.Composition.BladeInvocationHandler",["require","exports","f","o","a","ko","MsPortalImpl/Extension/Extension.Definition.Locator","MsPortalImpl/UI/Compositions/UI.Composition.BladeOpenerBase","MsPortalImpl/UI/Compositions/UI.Composition.BladeOpener.Helpers","MsPortalImpl/UI/Compositions/UI.Composition.PropertyBinding","MsPortalImpl/UI/UI.DesktopManager","MsPortalImpl/UI/Compositions/UI.Composition.StartboardPart","MsPortalImpl/UI/Compositions/UI.Composition.Journey","MsPortalImpl/UI/Compositions/UI.Composition.Blade"],(function(n,t,i,r,u,f,e,o,s,h,c,l){"use strict";function nt(n,t,i){function o(){return i.previousInvocationPromise}function s(n,r){var u=i.disableInvocation,e=r.invocationInput;f.unwrap(u)&&(p(a,"Invocation disabled. changes will be ignored and blade(s) not opened",t,e,r.value),n.indicateTaskComplete());return}function h(n,r){var c=r.propertyChanges,o,s,h;if(i.isThrottled()){n.indicateTaskComplete();return}if(o=c[0].propertyArrayEdits,o&&o.length>0&&(s=i.isThrottled,h=t.invocationThrottleDuration,h))return s(!0),u=!0,Q.delay(h).then((function(){e||(u=!1,s(!1),r.value=f.toJS(v(t.masterModel,r.invocationInput.source.property).value))}))}function c(){if(i.selectable2)return Q(t.referenceExtension.processMessages())}function l(n,r){var f=r.invocationInput,s=i.container,e=r.value,u,o;return(p(a,"Executing invocation property change",t,f,e),s.onInvocationStarted(),u=tt(t,i,e,s,i.detailsBladeLocator,i.registrationInfo),u.succeeded?(i.resettingMasterArrayValue=!1,i.prevValue=e):i.resettingMasterArrayValue?(a.error("Resetting value of master '{0}' also caused a prompt".format(t.masterModelId),0,i.prevValue),i.resettingMasterArrayValue=!1):(i.resettingMasterArrayValue=f.opensMultipleBlades,it(t,f,i.prevValue)),r.reboundBlade=u.reboundBlade,o=u.bladeOpenPromise,o)?o.then((function(n){r.openedBlades=n})):null}function y(){!e&&u&&i.isThrottled(!1);e=!0}var u=!1,e=!1,r;return n.registerForDispose(y),r=[],r[0]=o,r[1]=s,r[2]=h,r[3]=c,r[4]=l,r}function tt(n,t,r,u,f,e){var s=e.invocationInput,c=!0,o=s.opensMultipleBlades&&r,h,l,v,y;if(s.opensDynamicBlades&&(h=!1,r===null&&(r=undefined,h=!0),o&&(l=o.length,r=o=o.filter((function(n){return n!==null})),h=o.length!==l),v=i.isDevelopmentMode||i.trace.diagnostics,v&&h&&a.error("[BladeOpener]  Selectable is configured to open use dynamic invocation. Value of <null> is unexpected. \n Master Model id: "+n.masterModelId+"\n Property: "+s.source.property)),r===undefined||o&&o.length===0)y=n.getCloseOwnedDetailBladesHandler(s)||ut.bind(this,n,t,s),c=y();else return rt(n,t,r,u,f,e);return{succeeded:c,bladeOpenPromise:undefined,reboundBlade:undefined}}function it(n,t,i){var e=n.referenceExtension,r=function(){return e.processMessages()};r().then((function(){var l="Set invocation property '"+t.source.property+"' of master '"+n.masterModelId+"' to value.",y;a.verbose("START: "+l,i);var s=t.source.property,o=k(n,t),c=o&&o.isSelected;if(o&&c&&i!==undefined?(y=ft(o,n.masterModelId),y.setInternalSelectedValue(i),c()||c(!0)):h.setModelValue(n.masterModel,s,i),s.indexOf("activatedItems")>=0){var w=s.replace("activatedItems","selectedItems"),p=v(n.masterModel,w),e=p.exists&&p.value;f.isObservable(e)&&u.isArray(e())&&r().then((function(){e.splice.apply(e,[0,e().length].concat(i))}))}a.verbose("END: "+l,i)}))}function rt(n,t,r,e,h,l){var v=l.invocationInput,at=l.additionalInputs,ut=t.detailBladesTracker,vt=l.detailsDefinition,p=i.Helpers.Deferred(),w=function(){p.resolve([])},tt=r,it=!0,ft=n.getCloseOtherDetailBladesHandler(v,vt)||s.tryCloseOtherDetailBlades.bind(this,n,t,v,at),et=function(t){return n.onBladesOpening(t)},g=n.services.desktop,ot,nt,rt,lt;if(v.opensMultipleBlades&&!u.isArray(r))a.error("ViewModel property '"+v.source.property+"' of master '"+n.masterModelId+"' is marked as opening multiple blades, but its value is not an array. Value: "+JSON.stringify(r)+"."),w();else if(v.opensMultipleBlades&&tt.length>1)nt=r.map((function(i){return b(n,h,i,l,e,!!t.selectable2)})),(it=ft(nt,g.getContextPane()))?(et(nt),g.openMultipleBlades(e.id,nt).done((function(n){p.resolve(n)})),t.previousInvocationPromise=Q(p.promise()).finally((function(){t.previousInvocationPromise=undefined}))):w();else if(!u.isArray(r)||tt.length){var st=v.opensMultipleBlades?tt[0]:r,k=b(n,h,st,l,e,!!t.selectable2),yt=t.selectable2&&r.flags&64,pt=k&&k.flags&2;if(it=ft(yt?[]:[k],g.getContextPane())){var ht=ut.getBlades(),ct=void 0,d=ht[0];ht.length===1&&d.widget&&!pt==!(d.flags&2)&&(ct=!0,rt=y(n.referenceComposition.locator.toString(),st,v),c.isTraceEnabled&&a.verbose("[BladeOpener] Rebinding blade.\n  "+d+".\n  New Model: "+f.toJSON(rt)),ot=d,lt=d.rebindAsync(rt),t.selectable2?lt.finally(w):w());ct||(et([k]),g.openSingleBlade(e.id,k).done((function(n){p.resolve([n])})),t.previousInvocationPromise=Q(p.promise()).finally((function(){t.previousInvocationPromise=undefined})))}else w()}return p.done((function(i){var e=t.selectable2,s=l.invocationOutputs,h,r,c,v;i=i||[];h=i.filter((function(n){return e||n&&!(n.flags&2)}));r=h.length===1?h[0]:undefined;ut.track(i);e&&r?o.bindOutputsToSelectable2("Selectable2Outputs",e,r,e.getOutputProperties(),e.getOutputsChangedHandler()):h.length>0&&u.isArray(s)&&s.length>0&&(r?r.awaitComposed().then((function(){n.addOutputBindings(r,s)})):(c=i.map((function(n){return n.getDiagnosticsData()})),v="Unable to create output binding with detail blade, multiple detail blades found."+("\nMaster Model Debug Id: "+n.masterModelId+".")+("\nOutput Arguments: "+f.toJSON(s,null,2))+("\nDetail Blades: "+f.toJSON(c,null,2)),a.error(v)))})),{succeeded:it,bladeOpenPromise:Q(p.promise()),reboundBlade:ot}}function b(n,t,i,u,f,e){var c=u.invocationInput,a=u.detailsDefinition,d=u.additionalInputs,w=y(n.masterModelId,i,c),g=n.referenceComposition,b=c.opensDynamicBlades?et(n,i):t,h,o,p;b=s.getMappedBladeLocator(n.services,b,w,f);var v,k,nt=!1,tt=!!a.asSubJourney,it=!1;return c.opensDynamicBlades&&i&&(v=i.openInContextPane,k=i.persistentContextPane,e&&(nt=!!(i.flags&2),tt=!!(i.flags&8),it=!!(i.flags&128))),v===undefined&&(v=a.openInContextPane,k=a.persistentContextPane),h=v?1:0,k&&(h|=2),nt||(h|=4),tt&&(h|=8),it&&(h|=16),o={locator:b,masterInvocationProperty:c.source.property,bindings:d.slice(0),model:w,masterInputKeys:r.keys(w),masterDetailsDefinition:a,flags:h},d.forEach((function(n){o.model[n.targetProperty]=n.source.constantValue})),n.configureBindings&&o.bindings&&o.bindings.length&&n.configureBindings(o.bindings),n.configureBladeDescriptor(o),g instanceof l.Instance&&(o.openedByContext=g.openedByContext),p=n.referenceComposition&&n.referenceComposition.partDefinition,i&&(i.assetType&&i.detailBladeInputs?o.originAssetType=i.assetType:i.originAssetType&&i.detailBladeInputs&&i.detailBlade?(o.originAssetType=i.originAssetType,o.originAssetTypeExtension=i.originExtension):p&&(o.originAssetType=p&&p.assetType,o.originAssetTypeExtension=n.referenceExtension&&n.referenceExtension.name)),o}function ut(n,t,i,r){var o=n.services.desktop,h=t.detailBladesTracker,l,f,e,a;if(!o.getActiveJourney())return!0;var u=h.getBlades().filter((function(t){return!t.isDisposed()&&t.masterInvocationProperty===i.source.property&&n.isBladeOpenedByMaster(t)})),v=r||s.shouldSkipPromptForBladesWithEdits(n,u),c=v||o.confirmBladesCanClose(u.map((function(n){return n.id})));if(c)for(l=k(n,i)||{},f=u.length-1;f>=0;f--)e=u[f],a=l._msPortalFxDelayedBladeSelection,n.removeOutputBindings(e),h.untrack(e),o.forceCloseBlade(e.id,1,{openBlade:a});return c}function ft(n,t){var i=n;if(n)return i.lock&&i.setInternalSelectedValue&&i.isLocked||(a.error("selectable is not a framework implementation, view model = '"+t+"'"),i={lock:w,setInternalSelectedValue:function(t){n.selectedValue(t)},isLocked:w}),i}function k(n,t){var i=t.source.property.lastIndexOf("."),r=i>0?t.source.property.substring(0,i):"";return v(n.masterModel,r).value}function et(n,t){var i=n.referenceExtension;return o.mapDynamicSelectionToBladeLocator(n.services,t,d.forExtension(i.name),n.masterModelId)}r.defineProperty(t,"__esModule",{value:!0});var d=e.Locator,g=i.Base.Diagnostics,y=s.mapMasterModelToBladeModel,p=o.traceInvocationChange,a=g.createLog(n),w=i.noop,v=h.getModelValue;t.factory=nt}))