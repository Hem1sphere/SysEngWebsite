define("MsPortalImpl/UI/Hubs/UI.ResourceMapManager",["require","exports","f","i","o","Fx/ResourceManagement","FxInternal/Di","FxHubs/RpcEndPoints","MsPortalImpl/Extension/ExtensionManager","MsPortalImpl/Services/Services.AssetTypes"],(function(n,t,i,r,u,f,e,o,s,h){"use strict";function p(n,t){return{resourceId:n,assetId:null,extensionName:null,assetType:null,compositeDisplayName:null,icon:null,browseType:rt,viewModelLocator:null,viewModel:null,contracts:0,dynamicSelection:null,reason:i.getLogFriendlyMessage(t)}}function ut(n,t){i.disposeViewModelProperties(t);n.releaseViewModel(t)}function w(n){var t=it(n.message,n.stack);return t.readyState=n.readyState,t.status=n.status,t.statusText=n.statusText,t}var c;u.defineProperty(t,"__esModule",{value:!0});var b=i.Base,k=b.Constants,l=r.Extension,d=k.ExtensionNames.Hubs,g=b.Diagnostics,v=r.TriggerableLifetimeManager,y=g.createLog(n),nt="fulfilled",tt={name:"ResourceMap$ResourceProviderViewModel",module:"HubsExtension/ResourceMap/ViewModels/ResourceProviderViewModel","export":"ResourceProviderViewModel"},it=g.createIgnoreUnhandledRejectionError,rt=-1,a;(function(n){n.mapAssetIdToResourceIdOverride=null;n.mapResourceIdToAssetIdOverride=null;n.mapResourceIdToDynamicSelectionAndIconOverride=null;n.getResourceAssetInformationOverride=null;n.signalResourcesChangedOverride=null})(a=t.Internal||(t.Internal={}));c=(function(){function n(n,t){this._extensionManager=n;this._assetTypeService=t}return n.prototype._getResourceProvider=function(){var n=this;return this._providerPromise?this._providerPromise:(this._providerPromise=this._extensionManager.getHubsExtension().then((function(t){return t.getViewModel(tt,11).then((function(i){n._providerLifetime||(n._providerLifetime=new v);var r=!1;if(n._providerLifetime.registerForDispose((function(){r=!0;ut(t,i)})),!r)return i.content();throw h.createViewModelDisposedError("resource map provider",d,tt);}))})).catch((function(t){n._providerLifetime||(n._providerPromise=null);throw t;})),this._providerPromise)},n.prototype._getResourceTypeCachePromise=function(){return this._resourceTypeCachePromise?this._resourceTypeCachePromise:(this._resourceTypeCachePromise=this._getResourceProvider().then((function(n){return Q(n.getResourceTypeCache()).then((function(n){return n}))})),this._resourceTypeCachePromise)},n.prototype._getResourceTypeMapping=function(n,t){var i=n.assetTypeManifest.resourceType,r=i&&(i.mappingViewModelLocator||i.mappingViewModel),u;return r?(u=n.extension,this._extensionManager.getExtensionByName(u).then((function(n){return n.getViewModel(r,11).then((function(i){var f=!1;if(t.registerForDispose((function(){f=!0;ut(n,i)})),!f)return i.content();throw h.createViewModelDisposedError("resource type mapping",u,r);}))}))):Q.reject(it("The resource type does not have a resource type mapping view model."))},n.prototype._getResourceTypeMappingPacket=function(n){var r=this._assetTypeService,t=r.getAssetTypeByResourceType(n),i;return t?t.assetTypeManifest.resourceType.mappingViewModel?(i=new v,this._getResourceTypeMapping(t,i).then((function(r){return{resourceType:n,assetType:t,mapping:r,ltm:i}})).catch((function(){return i.dispose(),{resourceType:n}}))):Q({resourceType:n,assetType:t}):Q({resourceType:n})},n.prototype._getResourceAssetInformation=function(n,t,i){var o=this,s=a.getResourceAssetInformationOverride,u,e;return s?Q(s(n)):(u=r.lowerCaseStringMap(),n.forEach((function(n){var i=f.ArmId.parse(n).resourceType,t=u.get(i);t||(t=[],u.set(i,t));t.push(n)})),e=[],u.forEach((function(n,t){e.push(o._getResourceTypeMappingPacket(t))})),this._getResourceTypeCachePromise().then((function(){return Q.allSettled(e).then((function(n){var t=[],r;return n.forEach((function(n){if(n.state===nt){var f=n.value,s=f.resourceType.toLowerCase(),r=f.assetType,e=f.mapping;u.get(s).forEach((function(n){if(r){var u=function(t){return o._assetTypeService.mapResourceIdToDynamicSelectionAndIcon(n,i).then((function(i){var u=r.assetTypeManifest,e=u.name,f=u.browseType,o=u.viewModel,s=u.viewModelLocator,h=u.contracts;return{resourceId:n,assetId:t,extensionName:r.extension,assetType:e,compositeDisplayName:r.compositeDisplayName,icon:i.icon,browseType:f!==undefined?f:rt,viewModelLocator:s,viewModel:o,contracts:h,dynamicSelection:i.selection,isPreview:i.isPreview}})).catch((function(t){return y.error(t),p(n,t)}))};e?t.push(Q(e.mapResourceIdToAssetId(n)).then((function(n){return u(n)})).catch((function(t){return y.warning(t),p(n,t)}))):t.push(u(n))}else t.push(Q(p(n,new Error("No asset type for resource"))))}))}})),r=function(){n.forEach((function(n){n.state===nt&&n.value.ltm&&n.value.ltm.dispose()}))},Q.all(t).finally((function(){r()}))}))})))},n.prototype._signalResourcesChanged=function(n){var r=this,u=new v,t=n.map((function(n){return f.ArmId.parse(n).resourceType})),i;return t=t.unique(),i=[],t.forEach((function(n){var t=r._assetTypeService.getAssetTypeByResourceType(n);t&&t.assetTypeManifest.resourceType.mappingViewModel&&i.push(r._getResourceTypeMapping(t,u).then((function(n){return n.signalResourcesChanged?n.signalResourcesChanged():Q(!0)})))})),Q.all(i).finally((function(){u.dispose()}))},n.prototype._signalResourceGroupResourcesChanged=function(n,t){var r=this,i,u=[];t.resourcesInResourceGroup.forEach((function(n){var e,t,f;i=n.type;u.includes(i)&&(u.push(i),e=r._assetTypeService,t=e.getAssetTypeByResourceType(i),t&&t.assetTypeManifest.resourceType.mappingViewModel&&(f=new v,r._getResourceTypeMapping(t,f).then((function(n){var t=n.signalResourcesChanged;if(t)return t()})).catch((function(n){f.dispose();y.error("Could not signal asset type "+t.compositeDisplayName.plural+": "+n)})).finally((function(){f.dispose()}))))}))},n.prototype.dispose=function(){var n=this._providerLifetime;n&&n.dispose();this._providerLifetime=this._providerPromise=null},n.prototype.processResourceGroupChange=function(){return Q(!0)},n.prototype.getResourceGroup=function(n,t){return this._getResourceProvider().then((function(i){return Q(i.getResourceGroup(n,t))})).then((function(n){var t=n&&n.error;if(t)if(t.message)throw w(t);else throw t;return n.result}))},n.prototype.getResource=function(n,t){return this._getResourceProvider().then((function(i){return Q(i.getResource(n,t))})).then((function(n){var t=n&&n.error;if(t)if(t.message)throw w(t);else throw t;return n.result}))},n.prototype.getResourceGroupQueryResults=function(n,t,i){return this._getResourceProvider().then((function(t){return Q(t.getResourceGroupResults(n,i))})).then((function(n){var t=n&&n.error;if(t)if(t.message)throw w(t);else throw t;return n.result}))},n.prototype.mapAssetIdToResourceId=function(n){var t=a.mapAssetIdToResourceIdOverride;return t?Q(t(n)):this._assetTypeService.mapAssetIdToResourceId(n)},n.prototype.mapResourceIdToAssetId=function(n){var t=a.mapResourceIdToAssetIdOverride;return t?Q(t(n)):this._assetTypeService.mapResourceIdToAssetId(n)},n.prototype.mapResourceIdToDynamicSelectionAndIcon=function(n,t){var i=a.mapResourceIdToDynamicSelectionAndIconOverride;return i?Q(i(n)):this._assetTypeService.mapResourceIdToDynamicSelectionAndIcon(n,t)},n.prototype.getResourceAssetInformation=function(n,t){return this._getResourceAssetInformation(n,!0,t)},n.prototype.signalResourcesChanged=function(n){var t=a.signalResourcesChangedOverride;return t?Q(t(n)):this._signalResourcesChanged(n)},n.prototype.processAssetDeletion=function(n,t,i,r){var u={reason:"ResourceMapManager.processAssetDeletion"};n.name===d&&t===k.AssetNames.ResourceGroups?(this.processResourceGroupChange(i,u),r&&this._signalResourceGroupResourcesChanged(i,r)):this.processResourceGroupChange(null,u)},n})();c=__decorate([e.Class(),__metadata("design:paramtypes",[s.ExtensionManager,h.AssetTypeService])],c);t.ResourceMapManager=c;t.mapAssetIdToResourceId=e.defineHandler(l.mapAssetIdToResourceIdEndPoint,(function(n){return n.diContainer.get(c).mapAssetIdToResourceId(n.messageArg)}));t.mapResourceIdToAssetId=e.defineHandler(l.mapResourceIdToAssetIdEndPoint,(function(n){return n.diContainer.get(c).mapResourceIdToAssetId(n.messageArg)}));t.mapResourceIdToDynamicSelectionAndIcon=e.defineHandler(l.mapResourceIdToDynamicSelectionAndIconEndPoint,(function(n){return n.diContainer.get(c).mapResourceIdToDynamicSelectionAndIcon(n.messageArg.resourceId,{reason:"mapResourceIdToDynamicSelectionAndIcon",extension:n.messageContext.srcWindowId})}));t.getResourceAssetInformation=e.defineHandler(l.getResourceAssetInformationEndPoint,(function(n){return n.diContainer.get(c).getResourceAssetInformation(n.messageArg,{reason:"getResourceAssetInformation",extension:n.messageContext.srcWindowId})}));t.getResourceAssetInformationForHubs=e.defineHandler(o.AssetTypes.getResourceAssetInformationEndPoint,(function(n){return n.diContainer.get(c).getResourceAssetInformation(n.messageArg,{reason:"getResourceAssetInformationForHubs",extension:n.messageContext.srcWindowId})}));t.getResource=e.defineHandler(l.getResourceEndPoint,(function(n){return n.diContainer.get(c).getResource(n.messageArg.resourceId,{reason:n.messageArg.invoker+":getResource",extension:n.messageContext.srcWindowId})}));t.getResourceGroup=e.defineHandler(l.getResourceGroupEndPoint,(function(n){return n.diContainer.get(c).getResourceGroup(n.messageArg.resourceGroupId,{reason:n.messageArg.invoker+":getResourceGroup",extension:n.messageContext.srcWindowId})}));t.signalResourcesChanged=e.defineHandler(l.signalResourcesChangedEndPoint,(function(n){return Q(n.diContainer.get(c).signalResourcesChanged(n.messageArg))}))}))